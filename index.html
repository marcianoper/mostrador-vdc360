<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro Mostrador VDC 360Â°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body { font-family: sans-serif; background:#f2f2f2; padding:20px; }
    .container { background:#fff; padding:30px; border-radius:10px; max-width:900px; margin:auto; }
    h1 { color:green; display:flex; gap:10px; flex-wrap:wrap; }
    label { display:block; margin-top:15px; }
    input, select { width:100%; padding:10px; margin-top:5px; }
    button { margin-top:20px; padding:12px; background:#1f6f26; color:#fff; border:none; border-radius:5px; cursor:pointer; width:100%; font-weight:bold; }
    table { width:100%; margin-top:20px; border-collapse:collapse; }
    th, td { border:2px solid #1f6f26; padding:8px; text-align:center; }
    th { background:#1f6f26; color:#fff; }
    .subtitulo { font-size:22px; font-weight:bold; margin-top:40px; }
    .pill { background:#eef7ef; color:#1f6f26; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:800; }
    canvas { width:100%; }
  </style>
</head>

<body>
<div class="container">

<h1>
  Registro Mostrador VDC 360Â° matrix
  <span id="rt" class="pill">REAL TIME</span>
</h1>

<label>Fecha:
  <input type="date" id="fecha">
</label>

<label>Producto:
  <select id="producto">
    <option value="">Seleccionar</option>
    <option>Cabeza Congelada</option>
    <option>Cabeza de Rastro</option>
    <option>Cabeza de res</option>
    <option>Cabeza sin lengua</option>
    <option>Caja Excel</option>
    <option>Caja Menudo National</option>
    <option>Caja Menudo Swift</option>
    <option>Caja Washington</option>
    <option>Caja de tripa</option>
    <option>Caja menudo vÃ­sceras</option>
    <option>Corazon</option>
    <option>Higado</option>
    <option>Lengua</option>
    <option>Libro</option>
    <option>Menudo Canadian</option>
    <option>Nana</option>
    <option>Panza</option>
    <option>Pata Blanca</option>
    <option>Pata Morena</option>
    <option>Quajo</option>
    <option>Sebo</option>
    <option>Teleco</option>
    <option>Tripa</option>
    <option>Tripa Gorda</option>
    <option>Tripa de Rastro</option>
    <option>Tripa de rastro</option>
    <option>Producto Libre</option>
  </select>
</label>

<label>Kilos:
  <input type="number" id="kilos" step="0.01">
</label>

<label>Piezas:
  <input type="number" id="piezas">
</label>

<label>Origen:
  <input type="text" id="origen">
</label>

<label>Â¿Es congelado?
  <select id="congelado">
    <option>No</option>
    <option>SÃ­</option>
  </select>
</label>

<button id="btnAgregar">Agregar producto</button>

<h2 class="subtitulo">Productos enviados</h2>
<table id="tablaEnviados">
  <thead>
    <tr>
      <th>Producto</th>
      <th>Kilos</th>
      <th>Piezas</th>
      <th>Origen</th>
      <th>Congelado</th>
      <th>AcciÃ³n</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2 class="subtitulo">Resumen del dÃ­a</h2>
<table id="tablaResumen">
  <thead>
    <tr>
      <th>Producto</th>
      <th>Kilos</th>
      <th>Piezas</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div style="height:260px; margin-top:20px;">
  <canvas id="chartResumen"></canvas>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
/* ================= SUPABASE ================= */
const SUPABASE_URL = "https://eqynjddcosvdqjzztznn.supabase.co";
const SUPABASE_KEY = "TU_ANON_KEY_AQUI";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= UTILIDADES ================= */
const $ = s => document.querySelector(s);
const num = v => Number(v)||0;

function today(){
  const d = new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
  return d.toISOString().slice(0,10);
}

/* ðŸ”¤ ORDENAR PRODUCTOS */
function ordenarSelectAlfabeticamente(id){
  const select = document.getElementById(id);
  const options = Array.from(select.options);
  const first = options.shift();
  options.sort((a,b)=>a.text.localeCompare(b.text,'es',{sensitivity:'base'}));
  select.innerHTML='';
  select.appendChild(first);
  options.forEach(o=>select.appendChild(o));
}

/* ================= ESTADO ================= */
let enviados = [];
let chart = null;

/* ================= RENDER ================= */
function render(){
  const tbody = $('#tablaEnviados tbody');
  tbody.innerHTML = enviados.map(e=>`
    <tr>
      <td>${e.producto}</td>
      <td>${e.kilos.toFixed(2)}</td>
      <td>${e.piezas}</td>
      <td>${e.origen}</td>
      <td>${e.congelado}</td>
      <td><button onclick="eliminar('${e.id}')">Eliminar</button></td>
    </tr>`).join('');

  const resumen = {};
  enviados.forEach(e=>{
    if(!resumen[e.producto]) resumen[e.producto]={k:0,p:0};
    resumen[e.producto].k+=e.kilos;
    resumen[e.producto].p+=e.piezas;
  });

  const rows = Object.entries(resumen).map(([k,v])=>({producto:k,...v}));

  $('#tablaResumen tbody').innerHTML = rows.map(r=>`
    <tr>
      <td>${r.producto}</td>
      <td>${r.k.toFixed(2)}</td>
      <td>${r.p}</td>
    </tr>`).join('');

  const labels = rows.map(r=>r.producto);
  const kilos = rows.map(r=>r.k);
  const piezas = rows.map(r=>r.p);

  if(chart){
    chart.data.labels=labels;
    chart.data.datasets[0].data=kilos;
    chart.data.datasets[1].data=piezas;
    chart.update();
  }else{
    chart = new Chart($('#chartResumen'),{
      type:'bar',
      data:{labels,
        datasets:[
          {label:'Kilos',data:kilos},
          {label:'Piezas',data:piezas}
        ]}
    });
  }
}

/* ================= EVENTOS ================= */
$('#btnAgregar').onclick = async ()=>{
  const row = {
    fecha: $('#fecha').value,
    producto: $('#producto').value,
    kilos: num($('#kilos').value),
    piezas: num($('#piezas').value),
    origen: $('#origen').value,
    congelado: $('#congelado').value
  };

  const {data} = await sb.from('mostrador_enviados').insert(row).select().single();
  enviados.unshift(data);
  render();
};

/* ================= INIT ================= */
$('#fecha').value = today();
ordenarSelectAlfabeticamente('producto');
</script>

</body>
</html>
