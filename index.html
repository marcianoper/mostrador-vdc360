<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro Mostrador VDC 360Â°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; background:#f2f2f2; padding:20px; }
    .container { background:#fff; padding:30px; border-radius:10px; max-width:900px; margin:auto; }
    h1 { color:green; }
    label { display:block; margin-top:15px; }
    input, select { width:100%; padding:10px; margin-top:5px; }
    button { margin-top:20px; padding:12px; background:#1f6f26; color:#fff; border:none; border-radius:5px; cursor:pointer; width:100%; font-weight:bold; }
    table { width:100%; margin-top:20px; border-collapse:collapse; }
    th, td { border:2px solid #1f6f26; padding:8px; text-align:center; }
    th { background:#1f6f26; color:#fff; }
    .subtitulo { font-size:22px; font-weight:bold; margin-top:40px; }
    .hint { font-size:12px; color:#555; margin-top:8px; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; background:#eef7ef; color:#1f6f26; font-weight:700; font-size:12px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Registro Mostrador VDC 360Â° matrix <span id="rt" class="pill">REAL TIME</span></h1>
    <div class="hint">Todo lo que agregues/eliminÃ©s se sincroniza en vivo en otros dispositivos abiertos en la misma fecha.</div>

    <label>Fecha:
      <input type="date" id="fecha" value="">
    </label>

    <label>Producto:
      <select id="producto">
        <option value="">Seleccionar</option>
        <option value="Caja menudo vÃ­sceras">Caja menudo vÃ­sceras</option>
        <option value="Caja Menudo National">Caja Menudo National</option>
        <option value="Panza">Panza</option>
        <option value="Libro">Libro</option>
        <option value="Tripa">Tripa</option>
        <option value="Tripa de rastro">Tripa de rastro</option>
        <option value="Corazon">Corazon</option>
        <option value="Higado">Higado</option>
        <option value="Sebo">Sebo</option>
        <option value="Pata Blanca">Pata Blanca</option>
        <option value="Pata Morena">Pata Morena</option>
        <option value="Cabeza sin lengua">Cabeza sin lengua</option>
        <option value="Bofe">Bofe</option>
        <option value="Tripa Gorda">Tripa gorda</option>
        <option value="Caja Excel">Caja Excel</option>
        <option value="Menudo Canadian">Menudo Canadian</option>
        <option value="Caja Washington">Caja Washington</option>
        <option value="Cabeza de res">Cabeza de res</option>
        <option value="Teleco">Teleco</option>
        <option value="Nana">Nana</option>
        <option value="Cabeza de Rastro">Cabeza de Rastro</option>
        <option value="Tripa de Rastro">Tripa de Rastro</option>
        <option value="Cabeza Congelada">Cabeza Congelada</option>
        <option value="Quajo">Quajo</option>
        <option value="Producto Libre">Producto Libre</option>
        <option value="Lengua">Lengua</option>
        <option value="Caja de tripa">Caja de tripa</option>
        <option value="Caja Menudo Swift">Caja Menudo Swift</option>
      </select>
    </label>

    <label>Kilos:
      <input type="number" id="kilos" step="0.01" />
    </label>

    <label>Piezas (opcional):
      <input type="number" id="piezas" />
    </label>

    <label>Origen:
      <input type="text" id="origen" placeholder="Ej: rastro / limpieza / congelado" />
    </label>

    <label>Â¿Es congelado?
      <select id="congelado">
        <option value="No">No</option>
        <option value="SÃ­">SÃ­</option>
      </select>
    </label>

    <button id="btnAgregar">Agregar producto</button>

    <h2 class="subtitulo">Productos enviados</h2>
    <table id="tablaEnviados">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Kilos</th>
          <th>Piezas</th>
          <th>Origen</th>
          <th>Congelado</th>
          <th>AcciÃ³n</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2 class="subtitulo">Productos devueltos</h2>
    <label>Producto devuelto:
      <input type="text" id="productoDevuelto" />
    </label>

    <label>Kilos devueltos:
      <input type="number" id="kilosDevuelto" step="0.01" />
    </label>

    <button id="btnAgregarDev">Agregar producto devuelto</button>

    <table id="tablaDevueltos">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Kilos</th>
          <th>AcciÃ³n</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button onclick="enviarWhatsApp()">Enviar resumen a WhatsApp</button>
  </div>

  <!-- Supabase JS (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /* ===== CONFIG SUPABASE ===== */
    const SUPABASE_URL = "https://eqynjddcosvdqjzztznn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxeW5qZGRjb3N2ZHFqenp0em5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMzYwMzIsImV4cCI6MjA3MTcxMjAzMn0.Q51wsGelUvxRfqsMYRY5JduCGyZ7s6AzOhqsRf3kOhk";

    const sb = (window.supabase && window.supabase.createClient)
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    const T_ENVIADOS = "mostrador_enviados";
    const T_DEVUELTOS = "mostrador_devueltos";

    /* ===== Estado en memoria ===== */
    let enviados = [];   // [{id, producto, kilos, piezas, origen, congelado}]
    let devueltos = [];  // [{id, producto, kilos}]

    let rtChannel = null;

    const $ = (s)=>document.querySelector(s);

    function todayISODate(){
      const d = new Date();
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off*60000);
      return local.toISOString().slice(0,10);
    }

    function fechaSeleccionada(){
      return $('#fecha')?.value || todayISODate();
    }

    function num(v){
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    function renderTablaEnviados() {
      const tbody = document.querySelector("#tablaEnviados tbody");
      tbody.innerHTML = enviados.map((item) => `
        <tr>
          <td>${escapeHtml(item.producto)}</td>
          <td>${(+item.kilos).toFixed(2)}</td>
          <td>${item.piezas || 0}</td>
          <td>${escapeHtml(item.origen || '')}</td>
          <td>${escapeHtml(item.congelado || 'No')}</td>
          <td><button onclick="eliminarProducto('${item.id}')">Eliminar</button></td>
        </tr>`).join('');
    }

    function renderTablaDevueltos() {
      const tbody = document.querySelector("#tablaDevueltos tbody");
      tbody.innerHTML = devueltos.map((item) => `
        <tr>
          <td>${escapeHtml(item.producto)}</td>
          <td>${(+item.kilos).toFixed(2)}</td>
          <td><button onclick="eliminarDevuelto('${item.id}')">Eliminar</button></td>
        </tr>`).join('');
    }

    function escapeHtml(str){
      return String(str ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    /* ===== Carga inicial por fecha ===== */
    async function cargarDia(fecha){
      if(!sb) { alert("No cargÃ³ Supabase. Revisa el CDN o internet."); return; }

      // Enviados
      const { data: env, error: e1 } = await sb
        .from(T_ENVIADOS)
        .select("id, producto, kilos, piezas, origen, congelado")
        .eq("fecha", fecha)
        .order("created_at", { ascending: true });

      if(e1){ console.error(e1); }

      // Devueltos
      const { data: dev, error: e2 } = await sb
        .from(T_DEVUELTOS)
        .select("id, producto, kilos")
        .eq("fecha", fecha)
        .order("created_at", { ascending: true });

      if(e2){ console.error(e2); }

      enviados = (env || []).map(x=>({
        id:x.id,
        producto:x.producto,
        kilos:+x.kilos,
        piezas:+(x.piezas||0),
        origen:x.origen,
        congelado:x.congelado
      }));

      devueltos = (dev || []).map(x=>({
        id:x.id,
        producto:x.producto,
        kilos:+x.kilos
      }));

      renderTablaEnviados();
      renderTablaDevueltos();
    }

    /* ===== Realtime (suscripciÃ³n por fecha) ===== */
    async function conectarRealtime(fecha){
      if(!sb) return;

      // cerrar canal anterior
      if(rtChannel){
        try { await sb.removeChannel(rtChannel); } catch(e){}
        rtChannel = null;
      }

      // IMPORTANTE: filtros por fecha
      // Nota: supabase realtime filtra por "fecha=eq.YYYY-MM-DD"
      rtChannel = sb.channel(`mostrador-rt-${fecha}`);

      rtChannel
        .on('postgres_changes',
          { event: 'INSERT', schema: 'public', table: T_ENVIADOS, filter: `fecha=eq.${fecha}` },
          (payload)=>{
            const r = payload.new;
            // evitar duplicados
            if(enviados.some(x=>x.id===r.id)) return;
            enviados.push({
              id:r.id,
              producto:r.producto,
              kilos:+r.kilos,
              piezas:+(r.piezas||0),
              origen:r.origen,
              congelado:r.congelado
            });
            renderTablaEnviados();
          }
        )
        .on('postgres_changes',
          { event: 'DELETE', schema: 'public', table: T_ENVIADOS, filter: `fecha=eq.${fecha}` },
          (payload)=>{
            const id = payload.old?.id;
            if(!id) return;
            enviados = enviados.filter(x=>x.id!==id);
            renderTablaEnviados();
          }
        )
        .on('postgres_changes',
          { event: 'INSERT', schema: 'public', table: T_DEVUELTOS, filter: `fecha=eq.${fecha}` },
          (payload)=>{
            const r = payload.new;
            if(devueltos.some(x=>x.id===r.id)) return;
            devueltos.push({ id:r.id, producto:r.producto, kilos:+r.kilos });
            renderTablaDevueltos();
          }
        )
        .on('postgres_changes',
          { event: 'DELETE', schema: 'public', table: T_DEVUELTOS, filter: `fecha=eq.${fecha}` },
          (payload)=>{
            const id = payload.old?.id;
            if(!id) return;
            devueltos = devueltos.filter(x=>x.id!==id);
            renderTablaDevueltos();
          }
        );

      const status = await rtChannel.subscribe((s)=>{
        // s: 'SUBSCRIBED' | 'TIMED_OUT' | 'CLOSED' | 'CHANNEL_ERROR'
        const pill = $('#rt');
        if(!pill) return;
        if(s === 'SUBSCRIBED'){ pill.textContent = 'REAL TIME'; }
        else { pill.textContent = 'RT: ' + s; }
      });
    }

    /* ===== Agregar / Eliminar (ahora va a Supabase) ===== */
    async function agregarProducto() {
      const fecha = fechaSeleccionada();
      const producto = $('#producto').value;
      const kilos = $('#kilos').value;
      const piezas = $('#piezas').value || 0;
      const origen = $('#origen').value;
      const congelado = $('#congelado').value;

      if (!producto || !kilos || !origen) {
        alert("Por favor completa los campos obligatorios.");
        return;
      }

      const row = {
        fecha,
        producto,
        kilos: Number(parseFloat(kilos).toFixed(2)),
        piezas: parseInt(piezas || 0, 10) || 0,
        origen,
        congelado
      };

      const { error } = await sb.from(T_ENVIADOS).insert(row);
      if(error){
        console.error(error);
        alert("No se pudo guardar. Revisa internet o polÃ­ticas RLS.");
        return;
      }

      // limpiar inputs (opcional)
      $('#kilos').value = '';
      $('#piezas').value = '';
      // NO hacemos push manual: Realtime lo mete solo (asÃ­ siempre coincide)
    }

    async function agregarDevuelto() {
      const fecha = fechaSeleccionada();
      const producto = $('#productoDevuelto').value;
      const kilos = $('#kilosDevuelto').value;

      if (!producto || !kilos) {
        alert("Completa ambos campos del producto devuelto.");
        return;
      }

      const row = { fecha, producto, kilos: Number(parseFloat(kilos).toFixed(2)) };
      const { error } = await sb.from(T_DEVUELTOS).insert(row);
      if(error){
        console.error(error);
        alert("No se pudo guardar devuelto. Revisa internet o RLS.");
        return;
      }

      $('#productoDevuelto').value = '';
      $('#kilosDevuelto').value = '';
    }

    async function eliminarProducto(id) {
      if(!id) return;
      const { error } = await sb.from(T_ENVIADOS).delete().eq('id', id);
      if(error){
        console.error(error);
        alert("No se pudo eliminar. Revisa internet o RLS.");
      }
      // Realtime actualizarÃ¡ la tabla
    }

    async function eliminarDevuelto(id) {
      if(!id) return;
      const { error } = await sb.from(T_DEVUELTOS).delete().eq('id', id);
      if(error){
        console.error(error);
        alert("No se pudo eliminar devuelto. Revisa internet o RLS.");
      }
    }

    /* ===== WhatsApp (igual que tu lÃ³gica, pero usando arrays actuales) ===== */
    function enviarWhatsApp() {
      const fecha = fechaSeleccionada();

      const agrupadoEnviados = {};
      const agrupadoDevueltos = {};
      let totalKilosEnviados = 0;
      let totalKilosDevueltos = 0;

      enviados.forEach(p => {
        if (!agrupadoEnviados[p.producto]) agrupadoEnviados[p.producto] = { kilos: 0, piezas: 0 };
        agrupadoEnviados[p.producto].kilos += num(p.kilos);
        agrupadoEnviados[p.producto].piezas += parseInt(p.piezas || 0, 10);
        totalKilosEnviados += num(p.kilos);
      });

      devueltos.forEach(p => {
        if (!agrupadoDevueltos[p.producto]) agrupadoDevueltos[p.producto] = 0;
        agrupadoDevueltos[p.producto] += num(p.kilos);
        totalKilosDevueltos += num(p.kilos);
      });

      let mensaje = `*Resumen VDC 360Â° - ${fecha}*\n\n`;
      mensaje += `ðŸŸ¢ *Productos enviados:*\n`;
      for (const [producto, datos] of Object.entries(agrupadoEnviados)) {
        mensaje += `â€¢ ${producto}: ${datos.kilos.toFixed(2)} kg / ${datos.piezas} pzas\n`;
      }
      mensaje += `\nðŸ“¦ *Total kilos enviados:* ${totalKilosEnviados.toFixed(2)} kg\n`;

      if (devueltos.length > 0) {
        mensaje += `\nðŸ”´ *Productos devueltos:*\n`;
        for (const [producto, kilos] of Object.entries(agrupadoDevueltos)) {
          mensaje += `â€¢ ${producto}: ${kilos.toFixed(2)} kg\n`;
        }
        mensaje += `\nðŸ“¦ *Total kilos devueltos:* ${totalKilosDevueltos.toFixed(2)} kg\n`;
      }

      const url = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
      window.open(url, "_blank");
    }

    /* ===== Arranque ===== */
    document.getElementById("fecha").value = todayISODate();

    $('#btnAgregar').addEventListener('click', agregarProducto);
    $('#btnAgregarDev').addEventListener('click', agregarDevuelto);

    async function iniciar(){
      const f = fechaSeleccionada();
      await cargarDia(f);
      await conectarRealtime(f);
    }

    $('#fecha').addEventListener('change', async ()=>{
      const f = fechaSeleccionada();
      await cargarDia(f);
      await conectarRealtime(f);
    });

    iniciar();
  </script>
</body>
</html>
