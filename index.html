<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro Mostrador VDC 360Â°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body { font-family: sans-serif; background:#f2f2f2; padding:20px; }
    .container { background:#fff; padding:30px; border-radius:10px; max-width:900px; margin:auto; }
    h1 { color:green; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    label { display:block; margin-top:15px; }
    input, select { width:100%; padding:10px; margin-top:5px; }
    button { margin-top:20px; padding:12px; background:#1f6f26; color:#fff; border:none; border-radius:5px; cursor:pointer; width:100%; font-weight:bold; }
    table { width:100%; margin-top:20px; border-collapse:collapse; }
    th, td { border:2px solid #1f6f26; padding:8px; text-align:center; }
    th { background:#1f6f26; color:#fff; }
    .subtitulo { font-size:22px; font-weight:bold; margin-top:40px; }
    .hint { font-size:12px; color:#555; margin-top:8px; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; background:#eef7ef; color:#1f6f26; font-weight:800; font-size:12px; }
    .pill.off { background:#fff1f2; color:#b91c1c; }
    .row2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:720px){ .row2{ grid-template-columns:1fr; } }
    canvas{ width:100%; }

    /* UI BASCULA */
    .pesoBox{ margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pesoBtn{ width:auto; margin-top:0; padding:10px 12px; border-radius:10px; background:#0a7a3b; }
    .pesoToggle{ display:flex; gap:8px; align-items:center; border:1px solid #e5e7eb; padding:8px 10px; border-radius:999px; background:#f9fafb; font-weight:800; font-size:12px; color:#111; }
    .pesoToggle input{ width:18px; height:18px; }
    .pesoStatus{ display:inline-block; padding:6px 10px; border-radius:999px; background:#f3f4f6; font-weight:800; font-size:12px; color:#374151; }
    .pesoStatus.ok{ color:#0a7a3b; }
    .pesoStatus.bad{ color:#b91c1c; background:#fff1f2; }

    /* âœ… EdiciÃ³n inline */
    .miniBtn{
      margin-top:0;
      width:auto;
      padding:10px 12px;
      border-radius:10px;
      background:#1f6f26;
      font-weight:900;
    }
    .miniBtn.gray{ background:#374151; }
    .miniBtn.red{ background:#b91c1c; }
    .miniBtnRow{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    .cellInput{
      width:100%;
      padding:8px;
      border:1px solid #d1d5db;
      border-radius:10px;
      font-weight:700;
    }
    .cellSelect{
      width:100%;
      padding:8px;
      border:1px solid #d1d5db;
      border-radius:10px;
      font-weight:800;
      background:#fff;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>
      Registro Mostrador VDC 360Â° matrix
      <span id="rt" class="pill">REAL TIME</span>
    </h1>
    <div class="hint">Todo lo que agregues/eliminÃ©s se sincroniza en vivo en otros dispositivos abiertos en la misma fecha.</div>

    <label>Fecha:
      <input type="date" id="fecha" value="">
    </label>

    <label>Producto:
      <select id="producto">
        <option value="">Seleccionar</option>
        <option value="Caja menudo vÃ­sceras">Caja menudo vÃ­sceras</option>
        <option value="Caja Menudo National">Caja Menudo National</option>
        <option value="Panza">Panza</option>
        <option value="Libro">Libro</option>
        <option value="Tripa">Tripa</option>
        <option value="Tripa de rastro">Tripa de rastro</option>
        <option value="Corazon">Corazon</option>
        <option value="Higado">Higado</option>
        <option value="Sebo">Sebo</option>
        <option value="Pata Blanca">Pata Blanca</option>
        <option value="Pata Morena">Pata Morena</option>
        <option value="Cabeza sin lengua">Cabeza sin lengua</option>
        <option value="Bofe">Bofe</option>
        <option value="Tripa Gorda">Tripa gorda</option>
        <option value="Caja Excel">Caja Excel</option>
        <option value="Menudo Canadian">Menudo Canadian</option>
        <option value="Caja Washington">Caja Washington</option>
        <option value="Cabeza de res">Cabeza de res</option>
        <option value="Teleco">Teleco</option>
        <option value="Nana">Nana</option>
        <option value="Cabeza de Rastro">Cabeza de Rastro</option>
        <option value="Tripa de Rastro">Tripa de Rastro</option>
        <option value="Cabeza Congelada">Cabeza Congelada</option>
        <option value="Quajo">Quajo</option>
        <option value="Producto Libre">Producto Libre</option>
        <option value="Lengua">Lengua</option>
        <option value="Caja de tripa">Caja de tripa</option>
        <option value="Caja Menudo Swift">Caja Menudo Swift</option>
        <option value="Menudo sucio">Menudo sucio</option>
      </select>
    </label>

    <div class="row2">
      <label>Kilos:
        <input type="number" id="kilos" step="0.01" />

        <div class="pesoBox">
          <button id="btnPeso" type="button" class="pesoBtn">ðŸ“¥ Tomar peso</button>

          <span class="pesoToggle">
            <input type="checkbox" id="rtPesoToggle" />
            <span>Peso Real-time</span>
          </span>

          <span id="pesoStatus" class="pesoStatus">BÃ¡scula: esperandoâ€¦</span>
        </div>
      </label>

      <label>Piezas (opcional):
        <input type="number" id="piezas" />
      </label>
    </div>

    <label>Origen:
      <input type="text" id="origen" placeholder="Ej: rastro / limpieza / congelado" />
    </label>

    <label>Â¿Es congelado?
      <select id="congelado">
        <option value="No">No</option>
        <option value="SÃ­">SÃ­</option>
      </select>
    </label>

    <button id="btnAgregar">Agregar producto</button>

    <h2 class="subtitulo">Productos enviados (lo mÃ¡s nuevo arriba)</h2>
    <table id="tablaEnviados">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Kilos</th>
          <th>Piezas</th>
          <th>Origen</th>
          <th>Congelado</th>
          <th>AcciÃ³n</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2 class="subtitulo">Productos devueltos (lo mÃ¡s nuevo arriba)</h2>

    <label>Producto devuelto:
      <input type="text" id="productoDevuelto" />
    </label>

    <label>Kilos devueltos:
      <input type="number" id="kilosDevuelto" step="0.01" />
    </label>

    <button id="btnAgregarDev">Agregar producto devuelto</button>

    <table id="tablaDevueltos">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Kilos</th>
          <th>AcciÃ³n</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2 class="subtitulo">Resumen del dÃ­a (kilos y piezas)</h2>
    <table id="tablaResumen">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Kilos</th>
          <th>Piezas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div style="height:260px; margin-top:16px;">
      <canvas id="chartResumen"></canvas>
    </div>

    <button onclick="enviarWhatsApp()">Enviar resumen a WhatsApp</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    /* ===== CONFIG SUPABASE ===== */
    const SUPABASE_URL = "https://eqynjddcosvdqjzztznn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxeW5qZGRjb3N2ZHFqenp0em5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMzYwMzIsImV4cCI6MjA3MTcxMjAzMn0.Q51wsGelUvxRfqsMYRY5JduCGyZ7s6AzOhqsRf3kOhk";

    const sb = (window.supabase && window.supabase.createClient)
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    const T_ENVIADOS = "mostrador_enviados";
    const T_DEVUELTOS = "mostrador_devueltos";

    const T_BASCULA = "bascula_live";
    const BASCULA_ID = "torrey_1";

    let enviados = [];
    let devueltos = [];
    let rtChannel = null;
    let chBascula = null;

    const $ = (s)=>document.querySelector(s);

    function todayISODate(){
      const d = new Date();
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off*60000);
      return local.toISOString().slice(0,10);
    }
    function fechaSeleccionada(){ return $('#fecha')?.value || todayISODate(); }
    function num(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
    function escapeHtml(str){
      return String(str ?? '')
        .replaceAll('&','&amp;').replaceAll('<','&lt;')
        .replaceAll('>','&gt;').replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    /* ======= BÃ¡scula ======= */
    function setPesoStatus(msg, ok=true){
      const el = $('#pesoStatus');
      if(!el) return;
      el.textContent = msg || '';
      el.classList.remove('ok','bad');
      el.classList.add(ok ? 'ok' : 'bad');
    }
    function setKilosFromBascula(peso){
      const k = $('#kilos');
      if(!k) return;
      const next = Number(peso || 0);
      if(!Number.isFinite(next)) return;
      const cur = Number(k.value || 0);
      if(Math.abs(cur - next) < 0.001) return;
      k.value = next.toFixed(2);
      k.dispatchEvent(new Event('input', { bubbles:true }));
      k.dispatchEvent(new Event('change', { bubbles:true }));
    }
    async function leerBasculaOnce(){
      if(!sb){ alert("No cargÃ³ Supabase. Revisa el CDN o internet."); return; }
      setPesoStatus("BÃ¡scula: leyendoâ€¦", true);

      const { data, error } = await sb
        .from(T_BASCULA)
        .select("id,peso,updated_at")
        .eq("id", BASCULA_ID)
        .maybeSingle();

      if(error){
        console.error(error);
        setPesoStatus("BÃ¡scula: error lectura", false);
        alert("Error leyendo bÃ¡scula (bascula_live). Revisa RLS / tabla / internet.");
        return;
      }
      if(!data){
        setPesoStatus("BÃ¡scula: sin fila torrey_1", false);
        alert("No existe la fila bascula_live.id='torrey_1'.");
        return;
      }
      const peso = Number(data.peso);
      if(!Number.isFinite(peso)){
        setPesoStatus("BÃ¡scula: peso invÃ¡lido", false);
        return;
      }
      setKilosFromBascula(Math.abs(peso));
      setPesoStatus(`BÃ¡scula: OK ${Math.abs(peso).toFixed(2)} kg`, true);
    }
    async function conectarBasculaRealtime(){
      if(!sb) return;
      if(chBascula){
        try { await sb.removeChannel(chBascula); } catch(e){}
        chBascula = null;
      }
      chBascula = sb
        .channel(`bascula-live-${BASCULA_ID}`)
        .on(
          "postgres_changes",
          { event:"UPDATE", schema:"public", table:T_BASCULA, filter:`id=eq.${BASCULA_ID}` },
          (payload)=>{
            const peso = payload.new?.peso;
            if(typeof peso === 'number'){
              setKilosFromBascula(Math.abs(peso));
              setPesoStatus(`BÃ¡scula: ${Math.abs(peso).toFixed(2)} kg (RT)`, true);
            }
          }
        )
        .subscribe((s)=>{
          if(s === 'SUBSCRIBED') setPesoStatus("BÃ¡scula: RT listo âœ…", true);
          else if(s === 'CHANNEL_ERROR' || s === 'TIMED_OUT') setPesoStatus("BÃ¡scula: RT error", false);
        });
    }
    async function apagarBasculaRealtime(){
      if(!sb) return;
      if(chBascula){
        try { await sb.removeChannel(chBascula); } catch(e){}
        chBascula = null;
      }
      setPesoStatus("BÃ¡scula: esperandoâ€¦", true);
    }

    /* ===== Orden A-Z ===== */
    function ordenarSelectAlfabeticamente(selectId){
      const select = document.getElementById(selectId);
      if(!select) return;
      const options = Array.from(select.options);
      if(options.length <= 2) return;
      const first = options.shift();
      options.sort((a, b) => a.text.localeCompare(b.text, 'es', { sensitivity: 'base' }));
      select.innerHTML = '';
      select.appendChild(first);
      options.forEach(opt => select.appendChild(opt));
    }

    /* ===== Autofill (igual) ===== */
    const PESO_CAJA_2722 = 27.22;
    function norm(s){
      return String(s||'').trim().toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    }
    const PRODUCTOS_VIAJE = new Set([
      "bofe","cabeza de res","cabeza de rastro","cabeza sin lengua","corazon",
      "higado","libro","nana","panza","pata blanca","pata morena","cuajo",
      "quajo","sebo","teleco","tripa","tripa de rastro","tripa gorda"
    ].map(norm));
    const REGLAS_PRODUCTO = new Map([
      [norm("Menudo Canadian"),     { origen: "Promerca",  congelado: "SÃ­" }],
      [norm("Caja Menudo National"),{ origen: "Congelado", congelado: "SÃ­" }],
      [norm("Caja Washington"),     { origen: "Daniel",    congelado: "SÃ­" }],
      [norm("Lengua"),             { origen: "Anglo",     congelado: "SÃ­" }]
    ]);
    const PRODUCTOS_PESO_FIJO_2722 = new Set([ norm("Menudo Canadian"), norm("Caja Menudo National") ]);

    const touched = { origen:false, congelado:false, kilos:false };
    function markTouched(){
      const o = $('#origen'), c = $('#congelado'), k = $('#kilos');
      if(o) o.addEventListener('input', ()=> touched.origen = true);
      if(c) c.addEventListener('change', ()=> touched.congelado = true);
      if(k) k.addEventListener('input', ()=> touched.kilos = true);
    }
    function setIfNotTouched(field, value){
      if(field === 'origen' && !touched.origen) $('#origen').value = value;
      if(field === 'congelado' && !touched.congelado) $('#congelado').value = value;
      if(field === 'kilos' && !touched.kilos) $('#kilos').value = value;
    }
    function aplicarAutofillPorProducto(){
      const p = norm($('#producto')?.value || '');
      touched.origen = touched.congelado = touched.kilos = false;

      if(REGLAS_PRODUCTO.has(p)){
        const r = REGLAS_PRODUCTO.get(p);
        setIfNotTouched('origen', r.origen);
        setIfNotTouched('congelado', r.congelado);
      } else if(PRODUCTOS_VIAJE.has(p)){
        setIfNotTouched('origen', 'Viaje');
        setIfNotTouched('congelado', 'No');
      }
      recalcularKilosSiAplica();
    }
    function recalcularKilosSiAplica(){
      const p = norm($('#producto')?.value || '');
      if(!PRODUCTOS_PESO_FIJO_2722.has(p)) return;
      const piezas = num($('#piezas')?.value);
      if(!piezas) return;
      setIfNotTouched('kilos', (piezas * PESO_CAJA_2722).toFixed(2));
    }

    /* ===========================
       âœ… EDICIÃ“N INLINE
    =========================== */
    const editState = {
      envi: new Map(),  // id -> {editing:boolean, draft:{...}, backup:{...}}
      dev:  new Map()
    };

    function startEdit(kind, id){
      const list = (kind === 'envi') ? enviados : devueltos;
      const row = list.find(x=>x.id===id);
      if(!row) return;

      // una sola fila editando por tabla (opcional). Si quieres varias, quita esto.
      for(const [k,v] of (kind==='envi'?editState.envi:editState.dev).entries()){
        if(v.editing && k !== id){
          // auto-cancel anterior
          cancelEdit(kind, k);
        }
      }

      const stMap = (kind==='envi') ? editState.envi : editState.dev;
      stMap.set(id, {
        editing:true,
        backup: JSON.parse(JSON.stringify(row)),
        draft:  JSON.parse(JSON.stringify(row))
      });
      renderAll();
    }

    function cancelEdit(kind, id){
      const stMap = (kind==='envi') ? editState.envi : editState.dev;
      const s = stMap.get(id);
      if(!s) return;

      // restaura backup
      const list = (kind === 'envi') ? enviados : devueltos;
      const idx = list.findIndex(x=>x.id===id);
      if(idx >= 0) list[idx] = s.backup;

      stMap.delete(id);
      renderAll();
    }

    function setDraft(kind, id, field, value){
      const stMap = (kind==='envi') ? editState.envi : editState.dev;
      const s = stMap.get(id);
      if(!s) return;
      s.draft[field] = value;
    }

    async function saveEdit(kind, id){
      const stMap = (kind==='envi') ? editState.envi : editState.dev;
      const s = stMap.get(id);
      if(!s) return;

      const d = s.draft;

      if(kind === 'envi'){
        const payload = {
          producto: String(d.producto || '').trim(),
          kilos: Number(parseFloat(d.kilos).toFixed(2)),
          piezas: parseInt(d.piezas || 0, 10) || 0,
          origen: String(d.origen || '').trim(),
          congelado: (d.congelado === 'SÃ­' ? 'SÃ­' : 'No')
        };

        if(!payload.producto || !Number.isFinite(payload.kilos) || !payload.origen){
          alert("En ediciÃ³n: producto, kilos y origen son obligatorios.");
          return;
        }

        const { data, error } = await sb
          .from(T_ENVIADOS)
          .update(payload)
          .eq('id', id)
          .select("id, producto, kilos, piezas, origen, congelado, created_at")
          .single();

        if(error){
          console.error(error);
          alert("No se pudo guardar cambios (UPDATE). Revisa RLS / permisos.");
          cancelEdit(kind, id);
          return;
        }

        // aplica al array
        const idx = enviados.findIndex(x=>x.id===id);
        if(idx>=0){
          enviados[idx] = {
            id:data.id,
            producto:data.producto,
            kilos:+data.kilos,
            piezas:+(data.piezas||0),
            origen:data.origen,
            congelado:data.congelado,
            created_at:data.created_at
          };
        }

      } else {
        // devueltos
        const payload = {
          producto: String(d.producto || '').trim(),
          kilos: Number(parseFloat(d.kilos).toFixed(2))
        };
        if(!payload.producto || !Number.isFinite(payload.kilos)){
          alert("En devueltos: producto y kilos son obligatorios.");
          return;
        }

        const { data, error } = await sb
          .from(T_DEVUELTOS)
          .update(payload)
          .eq('id', id)
          .select("id, producto, kilos, created_at")
          .single();

        if(error){
          console.error(error);
          alert("No se pudo guardar cambios (UPDATE) en devueltos. Revisa RLS.");
          cancelEdit(kind, id);
          return;
        }

        const idx = devueltos.findIndex(x=>x.id===id);
        if(idx>=0){
          devueltos[idx] = { id:data.id, producto:data.producto, kilos:+data.kilos, created_at:data.created_at };
        }
      }

      stMap.delete(id);
      renderAll();
    }

    /* ===== Render tablas ===== */
    function renderTablaEnviados() {
      const tbody = document.querySelector("#tablaEnviados tbody");
      tbody.innerHTML = enviados.map((item) => {
        const st = editState.envi.get(item.id);
        const editing = !!st?.editing;
        const d = editing ? st.draft : item;

        return `
        <tr>
          <td>${
            editing
              ? `<input class="cellInput" value="${escapeHtml(d.producto)}"
                   oninput="setDraft('envi','${item.id}','producto', this.value)">`
              : `${escapeHtml(item.producto)}`
          }</td>

          <td>${
            editing
              ? `<input class="cellInput" type="number" step="0.01" value="${Number(d.kilos||0).toFixed(2)}"
                   oninput="setDraft('envi','${item.id}','kilos', this.value)">`
              : `${(+item.kilos).toFixed(2)}`
          }</td>

          <td>${
            editing
              ? `<input class="cellInput" type="number" value="${parseInt(d.piezas||0,10)}"
                   oninput="setDraft('envi','${item.id}','piezas', this.value)">`
              : `${item.piezas || 0}`
          }</td>

          <td>${
            editing
              ? `<input class="cellInput" value="${escapeHtml(d.origen||'')}"
                   oninput="setDraft('envi','${item.id}','origen', this.value)">`
              : `${escapeHtml(item.origen || '')}`
          }</td>

          <td>${
            editing
              ? `<select class="cellSelect"
                   onchange="setDraft('envi','${item.id}','congelado', this.value)">
                   <option value="No" ${d.congelado==='No'?'selected':''}>No</option>
                   <option value="SÃ­" ${d.congelado==='SÃ­'?'selected':''}>SÃ­</option>
                 </select>`
              : `${escapeHtml(item.congelado || 'No')}`
          }</td>

          <td>
            <div class="miniBtnRow">
              ${
                editing
                  ? `
                    <button class="miniBtn" onclick="saveEdit('envi','${item.id}')">Guardar</button>
                    <button class="miniBtn gray" onclick="cancelEdit('envi','${item.id}')">Cancelar</button>
                  `
                  : `
                    <button class="miniBtn" onclick="startEdit('envi','${item.id}')">Editar</button>
                    <button class="miniBtn red" onclick="eliminarProducto('${item.id}')">Eliminar</button>
                  `
              }
            </div>
          </td>
        </tr>`;
      }).join('');
    }

    function renderTablaDevueltos() {
      const tbody = document.querySelector("#tablaDevueltos tbody");
      tbody.innerHTML = devueltos.map((item) => {
        const st = editState.dev.get(item.id);
        const editing = !!st?.editing;
        const d = editing ? st.draft : item;

        return `
        <tr>
          <td>${
            editing
              ? `<input class="cellInput" value="${escapeHtml(d.producto)}"
                   oninput="setDraft('dev','${item.id}','producto', this.value)">`
              : `${escapeHtml(item.producto)}`
          }</td>

          <td>${
            editing
              ? `<input class="cellInput" type="number" step="0.01" value="${Number(d.kilos||0).toFixed(2)}"
                   oninput="setDraft('dev','${item.id}','kilos', this.value)">`
              : `${(+item.kilos).toFixed(2)}`
          }</td>

          <td>
            <div class="miniBtnRow">
              ${
                editing
                  ? `
                    <button class="miniBtn" onclick="saveEdit('dev','${item.id}')">Guardar</button>
                    <button class="miniBtn gray" onclick="cancelEdit('dev','${item.id}')">Cancelar</button>
                  `
                  : `
                    <button class="miniBtn" onclick="startEdit('dev','${item.id}')">Editar</button>
                    <button class="miniBtn red" onclick="eliminarDevuelto('${item.id}')">Eliminar</button>
                  `
              }
            </div>
          </td>
        </tr>`;
      }).join('');
    }

    /* ===== Resumen + chart ===== */
    function buildResumen(){
      const map = new Map();
      for(const r of enviados){
        const k = r.producto;
        if(!map.has(k)) map.set(k, { producto:k, kilos:0, piezas:0 });
        const o = map.get(k);
        o.kilos += num(r.kilos);
        o.piezas += parseInt(r.piezas||0,10);
      }
      return Array.from(map.values()).sort((a,b)=>b.kilos-a.kilos);
    }
    function renderResumen(){
      const rows = buildResumen();
      const tbody = document.querySelector("#tablaResumen tbody");
      tbody.innerHTML = rows.map(r=>`
        <tr>
          <td>${escapeHtml(r.producto)}</td>
          <td>${r.kilos.toFixed(2)}</td>
          <td>${r.piezas}</td>
        </tr>
      `).join('');
    }
    let chartResumen = null;
    function renderChart(){
      const rows = buildResumen();
      const labels = rows.map(r=>r.producto);
      const kilos = rows.map(r=>Number(r.kilos.toFixed(2)));
      const piezas = rows.map(r=>r.piezas);
      const canvas = document.getElementById('chartResumen');
      if(!canvas) return;

      if(chartResumen){
        chartResumen.data.labels = labels;
        chartResumen.data.datasets[0].data = kilos;
        chartResumen.data.datasets[1].data = piezas;
        chartResumen.update();
        return;
      }

      chartResumen = new Chart(canvas, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Kilos', data: kilos },
            { label: 'Piezas', data: piezas }
          ]
        },
        options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
      });
    }
    function renderAll(){
      renderTablaEnviados();
      renderTablaDevueltos();
      renderResumen();
      renderChart();
    }

    /* ===== Cargar dÃ­a ===== */
    async function cargarDia(fecha){
      if(!sb){ alert("No cargÃ³ Supabase. Revisa el CDN o internet."); return; }

      const { data: env, error: e1 } = await sb
        .from(T_ENVIADOS)
        .select("id, producto, kilos, piezas, origen, congelado, created_at")
        .eq("fecha", fecha)
        .order("created_at", { ascending: false });

      if(e1) console.error(e1);

      const { data: dev, error: e2 } = await sb
        .from(T_DEVUELTOS)
        .select("id, producto, kilos, created_at")
        .eq("fecha", fecha)
        .order("created_at", { ascending: false });

      if(e2) console.error(e2);

      enviados = (env || []).map(x=>({
        id:x.id,
        producto:x.producto,
        kilos:+x.kilos,
        piezas:+(x.piezas||0),
        origen:x.origen,
        congelado:x.congelado,
        created_at:x.created_at
      }));
      devueltos = (dev || []).map(x=>({
        id:x.id,
        producto:x.producto,
        kilos:+x.kilos,
        created_at:x.created_at
      }));

      // limpia estados de ediciÃ³n al cambiar de dÃ­a
      editState.envi.clear();
      editState.dev.clear();

      renderAll();
    }

    /* ===== Realtime ===== */
    async function conectarRealtime(fecha){
      if(!sb) return;

      if(rtChannel){
        try { await sb.removeChannel(rtChannel); } catch(e){}
        rtChannel = null;
      }

      rtChannel = sb.channel(`mostrador-rt-${fecha}`);

      rtChannel
        .on('postgres_changes',
          { event:'INSERT', schema:'public', table:T_ENVIADOS, filter:`fecha=eq.${fecha}` },
          (payload)=>{
            const r = payload.new;
            if(enviados.some(x=>x.id===r.id)) return;
            enviados.unshift({
              id:r.id,
              producto:r.producto,
              kilos:+r.kilos,
              piezas:+(r.piezas||0),
              origen:r.origen,
              congelado:r.congelado,
              created_at:r.created_at
            });
            renderAll();
          }
        )
        .on('postgres_changes',
          { event:'DELETE', schema:'public', table:T_ENVIADOS, filter:`fecha=eq.${fecha}` },
          (payload)=>{
            const id = payload.old?.id;
            if(!id) return;
            enviados = enviados.filter(x=>x.id!==id);
            editState.envi.delete(id);
            renderAll();
          }
        )
        .on('postgres_changes',
          { event:'UPDATE', schema:'public', table:T_ENVIADOS, filter:`fecha=eq.${fecha}` },
          (payload)=>{
            const r = payload.new;
            const idx = enviados.findIndex(x=>x.id===r.id);
            if(idx>=0 && !editState.envi.get(r.id)?.editing){
              enviados[idx] = {
                id:r.id,
                producto:r.producto,
                kilos:+r.kilos,
                piezas:+(r.piezas||0),
                origen:r.origen,
                congelado:r.congelado,
                created_at:r.created_at
              };
              renderAll();
            }
          }
        )
        .on('postgres_changes',
          { event:'INSERT', schema:'public', table:T_DEVUELTOS, filter:`fecha=eq.${fecha}` },
          (payload)=>{
            const r = payload.new;
            if(devueltos.some(x=>x.id===r.id)) return;
            devueltos.unshift({ id:r.id, producto:r.producto, kilos:+r.kilos, created_at:r.created_at });
            renderAll();
          }
        )
        .on('postgres_changes',
          { event:'DELETE', schema:'public', table:T_DEVUELTOS, filter:`fecha=eq.${fecha}` },
          (payload)=>{
            const id = payload.old?.id;
            if(!id) return;
            devueltos = devueltos.filter(x=>x.id!==id);
            editState.dev.delete(id);
            renderAll();
          }
        )
        .on('postgres_changes',
          { event:'UPDATE', schema:'public', table:T_DEVUELTOS, filter:`fecha=eq.${fecha}` },
          (payload)=>{
            const r = payload.new;
            const idx = devueltos.findIndex(x=>x.id===r.id);
            if(idx>=0 && !editState.dev.get(r.id)?.editing){
              devueltos[idx] = { id:r.id, producto:r.producto, kilos:+r.kilos, created_at:r.created_at };
              renderAll();
            }
          }
        );

      await rtChannel.subscribe((s)=>{
        const pill = $('#rt');
        if(!pill) return;
        if(s === 'SUBSCRIBED'){ pill.textContent = 'REAL TIME'; pill.classList.remove('off'); }
        else if(s === 'CHANNEL_ERROR' || s === 'TIMED_OUT'){ pill.textContent = 'RT: ' + s; pill.classList.add('off'); }
        else pill.textContent = 'RT: ' + s;
      });
    }

    /* ===== Inserts ===== */
    async function agregarProducto(){
      const fecha = fechaSeleccionada();
      const producto = $('#producto').value;
      const kilos = $('#kilos').value;
      const piezas = $('#piezas').value || 0;
      const origen = $('#origen').value;
      const congelado = $('#congelado').value;

      if(!producto || !kilos || !origen){
        alert("Por favor completa los campos obligatorios.");
        return;
      }

      const row = {
        fecha,
        producto,
        kilos: Number(parseFloat(kilos).toFixed(2)),
        piezas: parseInt(piezas || 0, 10) || 0,
        origen,
        congelado
      };

      const { data, error } = await sb
        .from(T_ENVIADOS)
        .insert(row)
        .select("id, producto, kilos, piezas, origen, congelado, created_at")
        .single();

      if(error){
        console.error(error);
        alert("No se pudo guardar. Revisa internet o polÃ­ticas RLS / Realtime.");
        return;
      }

      if(!enviados.some(x=>x.id===data.id)){
        enviados.unshift({
          id:data.id,
          producto:data.producto,
          kilos:+data.kilos,
          piezas:+(data.piezas||0),
          origen:data.origen,
          congelado:data.congelado,
          created_at:data.created_at
        });
        renderAll();
      }

      $('#kilos').value = '';
      $('#piezas').value = '';
    }

    async function agregarDevuelto(){
      const fecha = fechaSeleccionada();
      const producto = $('#productoDevuelto').value;
      const kilos = $('#kilosDevuelto').value;

      if(!producto || !kilos){
        alert("Completa ambos campos del producto devuelto.");
        return;
      }

      const row = { fecha, producto, kilos: Number(parseFloat(kilos).toFixed(2)) };

      const { data, error } = await sb
        .from(T_DEVUELTOS)
        .insert(row)
        .select("id, producto, kilos, created_at")
        .single();

      if(error){
        console.error(error);
        alert("No se pudo guardar devuelto. Revisa internet o RLS / Realtime.");
        return;
      }

      if(!devueltos.some(x=>x.id===data.id)){
        devueltos.unshift({ id:data.id, producto:data.producto, kilos:+data.kilos, created_at:data.created_at });
        renderAll();
      }

      $('#productoDevuelto').value = '';
      $('#kilosDevuelto').value = '';
    }

    async function eliminarProducto(id){
      if(!id) return;
      const { error } = await sb.from(T_ENVIADOS).delete().eq('id', id);
      if(error){ console.error(error); alert("No se pudo eliminar. Revisa internet o RLS."); }
    }

    async function eliminarDevuelto(id){
      if(!id) return;
      const { error } = await sb.from(T_DEVUELTOS).delete().eq('id', id);
      if(error){ console.error(error); alert("No se pudo eliminar devuelto. Revisa internet o RLS."); }
    }

    /* ===== WhatsApp ===== */
    function enviarWhatsApp(){
      const fecha = fechaSeleccionada();
      const agrupadoEnviados = {};
      const agrupadoDevueltos = {};
      let totalKilosEnviados = 0;
      let totalKilosDevueltos = 0;

      enviados.forEach(p => {
        if(!agrupadoEnviados[p.producto]) agrupadoEnviados[p.producto] = { kilos:0, piezas:0 };
        agrupadoEnviados[p.producto].kilos += num(p.kilos);
        agrupadoEnviados[p.producto].piezas += parseInt(p.piezas||0,10);
        totalKilosEnviados += num(p.kilos);
      });

      devueltos.forEach(p => {
        if(!agrupadoDevueltos[p.producto]) agrupadoDevueltos[p.producto] = 0;
        agrupadoDevueltos[p.producto] += num(p.kilos);
        totalKilosDevueltos += num(p.kilos);
      });

      let mensaje = `*Resumen VDC 360Â° - ${fecha}*\n\n`;
      mensaje += `ðŸŸ¢ *Productos enviados:*\n`;
      for(const [producto, datos] of Object.entries(agrupadoEnviados)){
        mensaje += `â€¢ ${producto}: ${datos.kilos.toFixed(2)} kg / ${datos.piezas} pzas\n`;
      }
      mensaje += `\nðŸ“¦ *Total kilos enviados:* ${totalKilosEnviados.toFixed(2)} kg\n`;

      if(devueltos.length > 0){
        mensaje += `\nðŸ”´ *Productos devueltos:*\n`;
        for(const [producto, kilos] of Object.entries(agrupadoDevueltos)){
          mensaje += `â€¢ ${producto}: ${kilos.toFixed(2)} kg\n`;
        }
        mensaje += `\nðŸ“¦ *Total kilos devueltos:* ${totalKilosDevueltos.toFixed(2)} kg\n`;
      }

      const url = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
      window.open(url, "_blank");
    }

    /* ===== Arranque ===== */
    document.getElementById("fecha").value = todayISODate();
    ordenarSelectAlfabeticamente('producto');
    markTouched();

    $('#producto').addEventListener('change', aplicarAutofillPorProducto);
    $('#piezas').addEventListener('input', ()=>{ touched.kilos = false; recalcularKilosSiAplica(); });

    $('#btnAgregar').addEventListener('click', agregarProducto);
    $('#btnAgregarDev').addEventListener('click', agregarDevuelto);

    $('#btnPeso').addEventListener('click', leerBasculaOnce);
    $('#rtPesoToggle').addEventListener('change', async (e)=>{
      if(e.target.checked){
        await conectarBasculaRealtime();
        await leerBasculaOnce();
      }else{
        await apagarBasculaRealtime();
      }
    });

    async function iniciar(){
      const f = fechaSeleccionada();
      await cargarDia(f);
      await conectarRealtime(f);
      aplicarAutofillPorProducto();
      setPesoStatus("BÃ¡scula: esperandoâ€¦", true);
    }

    $('#fecha').addEventListener('change', async ()=>{
      const f = fechaSeleccionada();
      await cargarDia(f);
      await conectarRealtime(f);
    });

    iniciar();

    /* âœ… Exponer funciones para onclick inline */
    window.startEdit = startEdit;
    window.cancelEdit = cancelEdit;
    window.saveEdit = saveEdit;
    window.setDraft = setDraft;
    window.eliminarProducto = eliminarProducto;
    window.eliminarDevuelto = eliminarDevuelto;
    window.enviarWhatsApp = enviarWhatsApp;
  </script>
</body>
</html>
