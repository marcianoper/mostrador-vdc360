<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro Mostrador VDC 360Â°</title>
  <style>
    body { font-family: sans-serif; background:#f2f2f2; padding:20px; }
    .container { background:#fff; padding:30px; border-radius:10px; max-width:900px; margin:auto; }
    h1 { color:green; }
    label { display:block; margin-top:15px; }
    input, select { width:100%; padding:10px; margin-top:5px; }
    button { margin-top:20px; padding:12px; background:#1f6f26; color:#fff; border:none; border-radius:5px; cursor:pointer; width:100%; font-weight:bold; }
    table { width:100%; margin-top:20px; border-collapse:collapse; }
    th, td { border:2px solid #1f6f26; padding:8px; text-align:center; }
    th { background:#1f6f26; color:#fff; }
    .subtitulo { font-size:22px; font-weight:bold; margin-top:40px; }
    .btnSec { background:#374151; }
    .rowBtns { display:flex; gap:10px; margin-top:12px; }
    .rowBtns button { width:100%; margin-top:0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Registro Mostrador VDC 360Â° matrix</h1>

    <label>Fecha:
      <input type="date" id="fecha" value="">
    </label>

    <label>Producto:
      <select id="producto">
        <option value="">Seleccionar</option>
        <option value="Caja menudo vÃ­sceras">Caja menudo vÃ­sceras</option>
        <option value="Caja Menudo National">Caja Menudo National</option>
        <option value="Panza">Panza</option>
        <option value="Libro">Libro</option>
        <option value="Tripa">Tripa</option>
        <option value="Tripa de rastro">TripÃ¡ de rastro</option>
        <option value="Corazon">Corazon</option>
        <option value="Higado">Higado</option>
        <option value="Sebo">Sebo</option>
        <option value="Pata Blanca">Pata Blanca</option>
        <option value="Pata Morena">Pata Morena</option>
        <option value="Cabeza sin lengua">Cabeza sin lengua</option>
        <option value="Bofe">Bofe</option>
        <option value="Tripa Gorda">Tripa gorda</option>
        <option value="Caja Excel">Caja Excel</option>
        <option value="Menudo Canadian">Menudo Canadian</option>
        <option value="Caja Washington">Caja Washington</option>
        <option value="Cabeza de res">Cabeza de res</option>
        <option value="Teleco">Teleco</option>
        <option value="Nana">Nana</option>
        <option value="Cabeza de Rastro">Cabeza de Rastro</option>
        <option value="Tripa de Rastro">Tripa de Rastro</option>
        <option value="Cabeza Congelada">Cabeza Congelada</option>
        <option value="Quajo">Quajo</option>
        <option value="Producto Libre">Producto Libre</option>
        <option value="Lengua">Lengua</option>
        <option value="Caja de tripa">Caja de tripa</option>
        <option value="Caja Menudo Swift">Caja Menudo Swift</option>
      </select>
    </label>

    <label>Kilos:
      <input type="number" id="kilos" />
    </label>

    <label>Piezas (opcional):
      <input type="number" id="piezas" />
    </label>

    <label>Origen:
      <input type="text" id="origen" />
    </label>

    <label>Â¿Es congelado?
      <select id="congelado">
        <option value="No">No</option>
        <option value="SÃ­">SÃ­</option>
      </select>
    </label>

    <div class="rowBtns">
      <button onclick="agregarProducto()">Agregar producto</button>
      <button class="btnSec" onclick="limpiarDiaActual()">Limpiar SOLO este dÃ­a</button>
    </div>

    <h2 class="subtitulo">Productos enviados</h2>
    <table id="tablaEnviados">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Kilos</th>
          <th>Piezas</th>
          <th>Origen</th>
          <th>Congelado</th>
          <th>AcciÃ³n</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2 class="subtitulo">Productos devueltos</h2>
    <label>Producto devuelto:
      <input type="text" id="productoDevuelto" />
    </label>

    <label>Kilos devueltos:
      <input type="number" id="kilosDevuelto" />
    </label>

    <button onclick="agregarDevuelto()">Agregar producto devuelto</button>

    <table id="tablaDevueltos">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Kilos</th>
          <th>AcciÃ³n</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button onclick="enviarWhatsApp()">Enviar resumen a WhatsApp</button>
  </div>

  <script>
    /* ===== Estado de la pÃ¡gina ===== */
    let enviados = [];
    let devueltos = [];

    function agregarProducto() {
      const producto = document.getElementById('producto').value;
      const kilos = document.getElementById('kilos').value;
      const piezas = document.getElementById('piezas').value || 0;
      const origen = document.getElementById('origen').value;
      const congelado = document.getElementById('congelado').value;

      if (!producto || !kilos || !origen) {
        alert("Por favor completa los campos obligatorios.");
        return;
      }

      enviados.push({
        producto,
        kilos: parseFloat(kilos),
        piezas: parseInt(piezas || 0, 10),
        origen,
        congelado
      });

      // limpiar campos rÃ¡pidos (opcional)
      document.getElementById('kilos').value = "";
      document.getElementById('piezas').value = "";
      // NO limpio producto/origen por si estÃ¡s capturando muchas tandas iguales

      renderTablaEnviados();
      scheduleSaves();
    }

    function agregarDevuelto() {
      const producto = document.getElementById('productoDevuelto').value;
      const kilos = document.getElementById('kilosDevuelto').value;

      if (!producto || !kilos) {
        alert("Completa ambos campos del producto devuelto.");
        return;
      }

      devueltos.push({ producto, kilos: parseFloat(kilos) });

      document.getElementById('productoDevuelto').value = "";
      document.getElementById('kilosDevuelto').value = "";

      renderTablaDevueltos();
      scheduleSaves();
    }

    function eliminarProducto(index) {
      enviados.splice(index, 1);
      renderTablaEnviados();
      scheduleSaves();
    }

    function eliminarDevuelto(index) {
      devueltos.splice(index, 1);
      renderTablaDevueltos();
      scheduleSaves();
    }

    function renderTablaEnviados() {
      const tbody = document.querySelector("#tablaEnviados tbody");
      tbody.innerHTML = enviados.map((item, index) => `
        <tr>
          <td>${escapeHtml(item.producto)}</td>
          <td>${(+item.kilos).toFixed(2)}</td>
          <td>${(item.piezas||0)}</td>
          <td>${escapeHtml(item.origen)}</td>
          <td>${escapeHtml(item.congelado)}</td>
          <td><button onclick="eliminarProducto(${index})">Eliminar</button></td>
        </tr>`).join('');
    }

    function renderTablaDevueltos() {
      const tbody = document.querySelector("#tablaDevueltos tbody");
      tbody.innerHTML = devueltos.map((item, index) => `
        <tr>
          <td>${escapeHtml(item.producto)}</td>
          <td>${(+item.kilos).toFixed(2)}</td>
          <td><button onclick="eliminarDevuelto(${index})">Eliminar</button></td>
        </tr>`).join('');
    }

    function enviarWhatsApp() {
      const fecha = document.getElementById("fecha").value;

      const agrupadoEnviados = {};
      const agrupadoDevueltos = {};
      let totalKilosEnviados = 0;
      let totalKilosDevueltos = 0;

      enviados.forEach(p => {
        if (!agrupadoEnviados[p.producto]) agrupadoEnviados[p.producto] = { kilos: 0, piezas: 0 };
        agrupadoEnviados[p.producto].kilos += parseFloat(p.kilos||0);
        agrupadoEnviados[p.producto].piezas += parseInt(p.piezas||0,10);
        totalKilosEnviados += parseFloat(p.kilos||0);
      });

      devueltos.forEach(p => {
        if (!agrupadoDevueltos[p.producto]) agrupadoDevueltos[p.producto] = 0;
        agrupadoDevueltos[p.producto] += parseFloat(p.kilos||0);
        totalKilosDevueltos += parseFloat(p.kilos||0);
      });

      let mensaje = `*Resumen VDC 360Â° - ${fecha}*\n\n`;
      mensaje += `ðŸŸ¢ *Productos enviados:*\n`;
      for (const [producto, datos] of Object.entries(agrupadoEnviados)) {
        mensaje += `â€¢ ${producto}: ${datos.kilos.toFixed(2)} kg / ${datos.piezas} pzas\n`;
      }
      mensaje += `\nðŸ“¦ *Total kilos enviados:* ${totalKilosEnviados.toFixed(2)} kg\n`;

      if (devueltos.length > 0) {
        mensaje += `\nðŸ”´ *Productos devueltos:*\n`;
        for (const [producto, kilos] of Object.entries(agrupadoDevueltos)) {
          mensaje += `â€¢ ${producto}: ${kilos.toFixed(2)} kg\n`;
        }
        mensaje += `\nðŸ“¦ *Total kilos devueltos:* ${totalKilosDevueltos.toFixed(2)} kg\n`;
      }

      const url = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
      window.open(url, "_blank");
    }

    /* ===============================
       AUTOSAVE LOCAL (POR DÃA)
       =============================== */
    const LOCAL_MODULE = 'mostrador';
    const $ = (s)=>document.querySelector(s);
    const $allInputs = ()=>Array.from(document.querySelectorAll('input, select, textarea'));

    function getDayKey(){
      const f = $('#fecha')?.value || new Date().toISOString().slice(0,10);
      return `${LOCAL_MODULE}-${f}`;
    }
    function lkey(){ return `draft:${getDayKey()}`; }

    function collectFormData(){
      const data = {};
      $allInputs().forEach(el=>{
        const k = el.id || el.name || el.dataset.key; if(!k) return;
        data[k] = (el.type==='checkbox') ? !!el.checked : el.value;
      });
      data.__enviados = enviados;
      data.__devueltos = devueltos;
      return data;
    }

    function applyFormData(data){
      if(!data) return;

      $allInputs().forEach(el=>{
        const k = el.id || el.name || el.dataset.key;
        if(!k || !(k in data)) return;
        if(el.type==='checkbox') el.checked = !!data[k];
        else el.value = data[k];
      });

      if (Array.isArray(data.__enviados)) {
        enviados = data.__enviados.map(x=>({
          ...x,
          kilos: +x.kilos,
          piezas: +(x.piezas||0)
        }));
        renderTablaEnviados();
      }
      if (Array.isArray(data.__devueltos)) {
        devueltos = data.__devueltos.map(x=>({
          ...x,
          kilos: +x.kilos
        }));
        renderTablaDevueltos();
      }
    }

    let hasUnsavedChanges=false, tLocal=null;

    function saveLocal(){
      const payload = { ts: Date.now(), data: collectFormData() };
      localStorage.setItem(lkey(), JSON.stringify(payload));
      hasUnsavedChanges = true;
    }

    function loadLocal(){
      const raw = localStorage.getItem(lkey());
      if(!raw) return;
      try {
        const parsed = JSON.parse(raw);
        if(parsed?.data) applyFormData(parsed.data);
      } catch {}
    }

    function clearLocal(){
      localStorage.removeItem(lkey());
      hasUnsavedChanges = false;
    }

    function onAnyChange(){
      clearTimeout(tLocal);
      tLocal = setTimeout(saveLocal, 350);
    }

    $allInputs().forEach(el=> el.addEventListener('input', onAnyChange));
    window.addEventListener('beforeunload', (e)=>{
      // solo avisa si hubo cambios guardados durante la sesiÃ³n
      if(!hasUnsavedChanges) return;
      e.preventDefault();
      e.returnValue = '';
    });

    function scheduleSaves(){ onAnyChange(); }

    function limpiarDiaActual(){
      const f = document.getElementById('fecha').value;
      if(!confirm(`Â¿Seguro que quieres borrar SOLO el registro del dÃ­a ${f}?`)) return;

      enviados = [];
      devueltos = [];
      renderTablaEnviados();
      renderTablaDevueltos();

      // limpiar campos sin tocar la fecha
      document.getElementById('producto').value = "";
      document.getElementById('kilos').value = "";
      document.getElementById('piezas').value = "";
      document.getElementById('origen').value = "";
      document.getElementById('congelado').value = "No";
      document.getElementById('productoDevuelto').value = "";
      document.getElementById('kilosDevuelto').value = "";

      clearLocal();
    }

    // Seguridad bÃ¡sica para evitar romper HTML con texto
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // Fecha por defecto: hoy
    document.getElementById("fecha").valueAsDate = new Date();

    // Inicializar: carga local del dÃ­a
    window.addEventListener('load', ()=>{
      loadLocal();
    });

    // Si cambias la fecha, cambia de â€œdraftâ€ (cada dÃ­a guarda lo suyo)
    document.querySelector('#fecha')?.addEventListener('change', ()=>{
      enviados = [];
      devueltos = [];
      renderTablaEnviados();
      renderTablaDevueltos();
      loadLocal();
    });
  </script>
</body>
</html>
