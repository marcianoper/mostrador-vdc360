<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro Mostrador ‚Äî VDC 360¬∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --brand:#0a7a3b;
      --brand2:#0f9a52;
      --bg:#f6f7f8;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --shadow:0 18px 50px rgba(2,6,23,.10);
      --shadow2:0 10px 24px rgba(2,6,23,.10);
      --r:18px;
      --danger:#b91c1c;
      --dark:#111827;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 520px at 18% -10%, rgba(15,154,82,.16), transparent 55%),
        radial-gradient(900px 420px at 98% 10%, rgba(10,122,59,.14), transparent 55%),
        var(--bg);
      color:var(--ink);
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:0 16px}

    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter:saturate(140%) blur(10px);
      background:rgba(246,247,248,.78);
      border-bottom:1px solid rgba(229,231,235,.75);
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 0;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width:260px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      box-shadow:0 10px 20px rgba(10,122,59,.20);
      display:grid; place-items:center;
      color:#fff; font-weight:1000;
      letter-spacing:.5px;
      user-select:none;
    }
    .title{ display:flex; flex-direction:column; line-height:1.1; }
    .title b{font-size:14px; letter-spacing:.2px}
    .title span{font-size:12px; color:var(--muted); font-weight:900; margin-top:4px}

    .barRight{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      font-weight:1000;
      font-size:12px;
      border:1px solid rgba(229,231,235,.95);
      background:rgba(255,255,255,.85);
      box-shadow:0 8px 18px rgba(2,6,23,.06);
      color:#111827;
      user-select:none;
    }
    .pill.ok{ color:var(--brand); background:rgba(10,122,59,.10); border-color: rgba(10,122,59,.18); }
    .pill.bad{ color:var(--danger); background:#fff1f2; border-color:#fecdd3; }
    .btnLink{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      text-decoration:none;
      font-weight:1000;
      border:1px solid rgba(229,231,235,.95);
      background:#fff;
      box-shadow:0 8px 18px rgba(2,6,23,.06);
    }
    .btnLink:hover{ filter:brightness(1.02); }

    main{padding:16px 0 26px}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background:var(--card);
      border-radius:22px;
      box-shadow:var(--shadow2);
      border:1px solid rgba(2,6,23,.06);
      padding:14px;
      overflow:hidden;
    }
    .cardHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .cardHead h2{
      margin:0;
      font-size:14px;
      font-weight:1000;
      letter-spacing:.2px;
    }
    .cardHead p{
      margin:8px 0 0;
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      line-height:1.35;
      max-width:70ch;
    }

    .form{ display:grid; gap:12px; }
    .row2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:720px){ .row2{ grid-template-columns:1fr; } }

    label{display:block; font-size:12px; font-weight:1000; color:#111827}
    .hint{font-size:12px;color:var(--muted);font-weight:800; margin-top:6px}

    input, select, textarea{
      width:100%;
      padding:11px 12px;
      margin-top:6px;
      border-radius:14px;
      border:1px solid rgba(229,231,235,.95);
      background:rgba(255,255,255,.92);
      outline:none;
      color:var(--ink);
      font-weight:800;
      box-shadow:0 8px 18px rgba(2,6,23,.06);
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(10,122,59,.35);
      box-shadow:0 0 0 4px rgba(10,122,59,.10), 0 8px 18px rgba(2,6,23,.06);
    }

    .btn{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:12px 14px;
      border:none;
      border-radius:16px;
      cursor:pointer;
      font-weight:1000;
      color:#fff;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      box-shadow:0 10px 20px rgba(10,122,59,.20);
      transition: filter .16s ease, transform .16s ease;
    }
    .btn:hover{ filter:brightness(1.05); transform: translateY(-1px); }
    .btn.dark{ background:#111827; box-shadow:0 10px 20px rgba(17,24,39,.18); }
    .btn.danger{ background:#b91c1c; box-shadow:0 10px 20px rgba(185,28,28,.18); }

    .pesoBox{ margin-top:8px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pesoBtn{
      width:auto;
      padding:10px 12px;
      border-radius:14px;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      color:#fff;
      border:none;
      cursor:pointer;
      font-weight:1000;
      box-shadow:0 10px 20px rgba(10,122,59,.18);
    }
    .pesoBtn:hover{ filter:brightness(1.05); }

    .pesoToggle{
      display:flex; gap:8px; align-items:center;
      border:1px solid rgba(229,231,235,.95);
      padding:8px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.85);
      font-weight:1000;
      font-size:12px;
      color:#111827;
      box-shadow:0 8px 18px rgba(2,6,23,.06);
    }
    .pesoToggle input{ width:18px; height:18px; margin:0; accent-color: var(--brand); box-shadow:none; }

    .pesoStatus{
      display:inline-flex;
      align-items:center;
      padding:8px 10px;
      border-radius:999px;
      background:#f3f4f6;
      font-weight:1000;
      font-size:12px;
      color:#374151;
      border:1px solid #e5e7eb;
    }
    .pesoStatus.ok{ color:var(--brand); background:rgba(10,122,59,.10); border-color: rgba(10,122,59,.18); }
    .pesoStatus.bad{ color:var(--danger); background:#fff1f2; border-color:#fecdd3; }

    .tableCard{ margin-top:14px; }
    .tableTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .tableTop .sub{
      font-size:13px;
      font-weight:1000;
      margin:0;
    }
    .tableTop .sub small{
      display:block;
      margin-top:6px;
      font-size:12px;
      font-weight:800;
      color:var(--muted);
    }

    .tableWrap{
      overflow:auto;
      border-radius:18px;
      border:1px solid rgba(229,231,235,.95);
      box-shadow:0 10px 24px rgba(2,6,23,.06);
      background:#fff;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width:760px;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(229,231,235,.9);
      text-align:center;
      font-weight:800;
      font-size:12.5px;
      white-space:nowrap;
    }
    th{
      position:sticky; top:0;
      background:#111827;
      color:#fff;
      z-index:2;
      font-weight:1000;
      letter-spacing:.2px;
    }
    td:first-child, th:first-child{ text-align:left; padding-left:12px; }
    tr:hover td{ background:#f9fafb; }

    .miniBtnRow{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    .miniBtn{
      width:auto;
      padding:9px 10px;
      border:none;
      border-radius:12px;
      cursor:pointer;
      font-weight:1000;
      color:#fff;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      box-shadow:0 10px 18px rgba(10,122,59,.14);
    }
    .miniBtn.gray{ background:#374151; box-shadow:0 10px 18px rgba(55,65,81,.16); }
    .miniBtn.red{ background:#b91c1c; box-shadow:0 10px 18px rgba(185,28,28,.16); }

    .cellInput, .cellSelect{
      width:100%;
      padding:8px 10px;
      border:1px solid rgba(229,231,235,.95);
      border-radius:12px;
      font-weight:900;
      background:#fff;
      box-shadow:none;
      margin:0;
    }

    .chartBox{
      height:280px;
      margin-top:14px;
      border-radius:22px;
      border:1px solid rgba(229,231,235,.95);
      background:#fff;
      box-shadow:0 10px 24px rgba(2,6,23,.06);
      padding:10px;
    }
    canvas{ width:100%; height:100%; }

    footer{
      text-align:center;
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      padding:12px 0 24px;
    }

    @media (max-width:520px){
      .brand{ min-width:unset; }
      table{ min-width:720px; }
    }
  </style>
</head>

<body>

<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">VDC</div>
        <div class="title">
          <b>Registro Mostrador ‚Äî VDC 360¬∞</b>
          <span>Captura + Realtime + Resumen del d√≠a</span>
        </div>
      </div>

      <div class="barRight">
        <a class="btnLink" href="https://marcianoper.github.io/vdc-central/">‚Üê VDC Central</a>
        <span id="rt" class="pill ok">REAL TIME</span>
      </div>
    </div>
  </div>
</header>

<main class="wrap">

  <div class="grid">

    <section class="card">
      <div class="cardHead">
        <div>
          <h2>Captura de producto enviado</h2>
          <p>Todo lo que agregues/elimin√©s se sincroniza en vivo en otros dispositivos abiertos en la misma fecha.</p>
        </div>
      </div>

      <div class="form">
        <label>Fecha
          <input type="date" id="fecha" value="">
          <div class="hint">Tip: si cambias la fecha, el sistema carga todo ese d√≠a y re-conecta el realtime.</div>
        </label>

        <label>Producto
          <select id="producto">
            <option value="">Seleccionar</option>
            <option value="Caja menudo v√≠sceras">Caja menudo v√≠sceras</option>
            <option value="Caja Menudo National">Caja Menudo National</option>
            <option value="Panza">Panza</option>
            <option value="Libro">Libro</option>
            <option value="Tripa">Tripa</option>
            <option value="Tripa de rastro">Tripa de rastro</option>
            <option value="Corazon">Corazon</option>
            <option value="Higado">Higado</option>
            <option value="Sebo">Sebo</option>
            <option value="Pata Blanca">Pata Blanca</option>
            <option value="Pata Morena">Pata Morena</option>
            <option value="Cabeza sin lengua">Cabeza sin lengua</option>
            <option value="Bofe">Bofe</option>
            <option value="Tripa Gorda">Tripa gorda</option>
            <option value="Caja Excel">Caja Excel</option>
            <option value="Menudo Canadian">Menudo Canadian</option>
            <option value="Caja Washington">Caja Washington</option>
            <option value="Cabeza de res">Cabeza de res</option>
            <option value="Teleco">Teleco</option>
            <option value="Nana">Nana</option>
            <option value="Cabeza de Rastro">Cabeza de Rastro</option>
            <option value="Tripa de Rastro">Tripa de Rastro</option>
            <option value="Cabeza Congelada">Cabeza Congelada</option>
            <option value="Quajo">Quajo</option>
            <option value="Producto Libre">Producto Libre</option>
            <option value="Lengua">Lengua</option>
            <option value="Caja de tripa">Caja de tripa</option>
            <option value="Caja Menudo Swift">Caja Menudo Swift</option>
            <option value="Menudo sucio">Menudo sucio</option>
          </select>
        </label>

        <div class="row2">
          <label>Kilos
            <input type="number" id="kilos" step="0.01" />

            <div class="pesoBox">
              <button id="btnPeso" type="button" class="pesoBtn">üì• Tomar peso</button>

              <span class="pesoToggle">
                <input type="checkbox" id="rtPesoToggle" />
                <span>Peso Real-time</span>
              </span>

              <span id="pesoStatus" class="pesoStatus">B√°scula: esperando‚Ä¶</span>
            </div>
          </label>

          <label>Piezas (opcional)
            <input type="number" id="piezas" />
          </label>
        </div>

        <label>Origen
          <input type="text" id="origen" placeholder="Ej: rastro / limpieza / congelado" />
        </label>

        <label>¬øEs congelado?
          <select id="congelado">
            <option value="No">No</option>
            <option value="S√≠">S√≠</option>
          </select>
        </label>

        <button id="btnAgregar" class="btn">‚ûï Agregar producto</button>
      </div>
    </section>

    <section class="card">
      <div class="cardHead">
        <div>
          <h2>Productos devueltos</h2>
          <p>Registra devoluciones para control del d√≠a. (El resumen abajo hoy solo agrupa enviados, lo dejamos igual que tu l√≥gica actual.)</p>
        </div>
      </div>

      <div class="form">
        <label>Producto devuelto
          <input type="text" id="productoDevuelto" placeholder="Ej: Panza / Tripa / etc." />
        </label>

        <label>Kilos devueltos
          <input type="number" id="kilosDevuelto" step="0.01" />
        </label>

        <button id="btnAgregarDev" class="btn dark">‚Ü©Ô∏è Agregar devuelto</button>

        <button onclick="enviarWhatsApp()" class="btn">üì≤ Enviar resumen a WhatsApp</button>

        <div class="hint">
          Tip: puedes abrir esta p√°gina en una tablet y dejarla fija todo el d√≠a.
        </div>
      </div>
    </section>

  </div>

  <section class="card tableCard">
    <div class="tableTop">
      <p class="sub">Productos enviados (lo m√°s nuevo arriba)
        <small>Editar solo si de verdad lo necesitas ‚Äî si no, elimina y vuelve a capturar (m√°s r√°pido).</small>
      </p>
    </div>

    <div class="tableWrap">
      <table id="tablaEnviados">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Kilos</th>
            <th>Piezas</th>
            <th>Origen</th>
            <th>Congelado</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="card tableCard">
    <div class="tableTop">
      <p class="sub">Devueltos (lo m√°s nuevo arriba)</p>
    </div>

    <div class="tableWrap">
      <table id="tablaDevueltos">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Kilos</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="card tableCard">
    <div class="tableTop">
      <p class="sub">Resumen del d√≠a (kilos y piezas)
        <small>Gr√°fica abajo para ver r√°pido qu√© se movi√≥ m√°s.</small>
      </p>
    </div>

    <div class="tableWrap">
      <table id="tablaResumen">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Kilos</th>
            <th>Piezas</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="chartBox">
      <canvas id="chartResumen"></canvas>
    </div>
  </section>

  <footer>
    VDC 360¬∞ ¬∑ Mostrador ¬∑ Marciano mode ‚úÖ
  </footer>

</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  /* ===== CONFIG SUPABASE ===== */
  const SUPABASE_URL = "https://eqynjddcosvdqjzztznn.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxeW5qZGRjb3N2ZHFqenp0em5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMzYwMzIsImV4cCI6MjA3MTcxMjAzMn0.Q51wsGelUvxRfqsMYRY5JduCGyZ7s6AzOhqsRf3kOhk";

  const sb = (window.supabase && window.supabase.createClient)
    ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    : null;

  const T_ENVIADOS = "mostrador_enviados";
  const T_DEVUELTOS = "mostrador_devueltos";

  const T_BASCULA = "bascula_live";
  const BASCULA_ID = "torrey_1";

  /* ====== INVENTARIO MOSTRADOR (Ledger) ====== */
  const T_MOV = "movimientos_inventario";

  // Mapa producto->SKU (estable)
  const SKU_MAP = {
    "Caja menudo v√≠sceras":   "CAJA_MENUDO_VISCERAS",
    "Caja Menudo National":   "CAJA_MENUDO_NATIONAL",
    "Panza":                  "PANZA",
    "Libro":                  "LIBRO",
    "Tripa":                  "TRIPA",
    "Tripa de rastro":        "TRIPA_RASTRO",
    "Tripa de Rastro":        "TRIPA_RASTRO",
    "Corazon":                "CORAZON",
    "Higado":                 "HIGADO",
    "Sebo":                   "SEBO",
    "Pata Blanca":            "PATA_BLANCA",
    "Pata Morena":            "PATA_MORENA",
    "Cabeza sin lengua":      "CABEZA_SIN_LENGUA",
    "Cabeza de res":          "CABEZA_RES",
    "Bofe":                   "BOFE",
    "Tripa Gorda":            "TRIPA_GORDA",
    "Caja Excel":             "CAJA_EXCEL",
    "Menudo Canadian":        "MENUDO_CANADIAN",
    "Caja Washington":        "CAJA_WASHINGTON",
    "Teleco":                 "TELECO",
    "Nana":                   "NANA",
    "Cabeza de Rastro":       "CABEZA_RASTRO",
    "Cabeza de rastro":       "CABEZA_RASTRO",
    "Cabeza Congelada":       "CABEZA_CONGELADA",
    "Quajo":                  "CUAJO",
    "Cuajo":                  "CUAJO",
    "Producto Libre":         "PRODUCTO_LIBRE",
    "Lengua":                 "LENGUA",
    "Caja de tripa":          "CAJA_TRIPA",
    "Caja Menudo Swift":      "CAJA_MENUDO_SWIFT",
    "Menudo sucio":           "MENUDO_SUCI0"
  };

  function toSku(producto){
    const key = String(producto || "").trim();
    return SKU_MAP[key] || key.toUpperCase().replace(/\s+/g, "_");
  }
  function buildItem(producto, kilos, piezas){
    return [{
      sku: toSku(producto),
      kg: Number(kilos || 0),
      pzas: Number(piezas || 0)
    }];
  }
  async function pushMovimiento({ tipo, origen, ref, items }){
    if(!sb) return { ok:false, error:"No Supabase client" };
    const payload = { tipo, origen: origen || "mostrador", ref: ref || "", items: items || [] };
    const { error } = await sb.from(T_MOV).insert(payload);
    if(error){
      console.error("Movimiento error:", error);
      return { ok:false, error: error.message };
    }
    return { ok:true };
  }

  let enviados = [];
  let devueltos = [];
  let rtChannel = null;
  let chBascula = null;

  const $ = (s)=>document.querySelector(s);

  function todayISODate(){
    const d = new Date();
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off*60000);
    return local.toISOString().slice(0,10);
  }
  function fechaSeleccionada(){ return $('#fecha')?.value || todayISODate(); }
  function num(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
  function escapeHtml(str){
    return String(str ?? '')
      .replaceAll('&','&amp;').replaceAll('<','&lt;')
      .replaceAll('>','&gt;').replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  /* ======= B√°scula ======= */
  function setPesoStatus(msg, ok=true){
    const el = $('#pesoStatus');
    if(!el) return;
    el.textContent = msg || '';
    el.classList.remove('ok','bad');
    el.classList.add(ok ? 'ok' : 'bad');
  }
  function setKilosFromBascula(peso){
    const k = $('#kilos');
    if(!k) return;
    const next = Number(peso || 0);
    if(!Number.isFinite(next)) return;
    const cur = Number(k.value || 0);
    if(Math.abs(cur - next) < 0.001) return;
    k.value = next.toFixed(2);
    k.dispatchEvent(new Event('input', { bubbles:true }));
    k.dispatchEvent(new Event('change', { bubbles:true }));
  }
  async function leerBasculaOnce(){
    if(!sb){ alert("No carg√≥ Supabase. Revisa el CDN o internet."); return; }
    setPesoStatus("B√°scula: leyendo‚Ä¶", true);

    const { data, error } = await sb
      .from(T_BASCULA)
      .select("id,peso,updated_at")
      .eq("id", BASCULA_ID)
      .maybeSingle();

    if(error){
      console.error(error);
      setPesoStatus("B√°scula: error lectura", false);
      alert("Error leyendo b√°scula (bascula_live). Revisa RLS / tabla / internet.");
      return;
    }
    if(!data){
      setPesoStatus("B√°scula: sin fila torrey_1", false);
      alert("No existe la fila bascula_live.id='torrey_1'.");
      return;
    }
    const peso = Number(data.peso);
    if(!Number.isFinite(peso)){
      setPesoStatus("B√°scula: peso inv√°lido", false);
      return;
    }
    setKilosFromBascula(Math.abs(peso));
    setPesoStatus(`B√°scula: OK ${Math.abs(peso).toFixed(2)} kg`, true);
  }
  async function conectarBasculaRealtime(){
    if(!sb) return;
    if(chBascula){
      try { await sb.removeChannel(chBascula); } catch(e){}
      chBascula = null;
    }
    chBascula = sb
      .channel(`bascula-live-${BASCULA_ID}`)
      .on(
        "postgres_changes",
        { event:"UPDATE", schema:"public", table:T_BASCULA, filter:`id=eq.${BASCULA_ID}` },
        (payload)=>{
          const peso = payload.new?.peso;
          if(typeof peso === 'number'){
            setKilosFromBascula(Math.abs(peso));
            setPesoStatus(`B√°scula: ${Math.abs(peso).toFixed(2)} kg (RT)`, true);
          }
        }
      )
      .subscribe((s)=>{
        if(s === 'SUBSCRIBED') setPesoStatus("B√°scula: RT listo ‚úÖ", true);
        else if(s === 'CHANNEL_ERROR' || s === 'TIMED_OUT') setPesoStatus("B√°scula: RT error", false);
      });
  }
  async function apagarBasculaRealtime(){
    if(!sb) return;
    if(chBascula){
      try { await sb.removeChannel(chBascula); } catch(e){}
      chBascula = null;
    }
    setPesoStatus("B√°scula: esperando‚Ä¶", true);
  }

  /* ===== Orden A-Z ===== */
  function ordenarSelectAlfabeticamente(selectId){
    const select = document.getElementById(selectId);
    if(!select) return;
    const options = Array.from(select.options);
    if(options.length <= 2) return;
    const first = options.shift();
    options.sort((a, b) => a.text.localeCompare(b.text, 'es', { sensitivity: 'base' }));
    select.innerHTML = '';
    select.appendChild(first);
    options.forEach(opt => select.appendChild(opt));
  }

  /* ===== Autofill (igual) ===== */
  const PESO_CAJA_2722 = 27.22;
  function norm(s){
    return String(s||'').trim().toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  }
  const PRODUCTOS_VIAJE = new Set([
    "bofe","cabeza de res","cabeza de rastro","cabeza sin lengua","corazon",
    "higado","libro","nana","panza","pata blanca","pata morena","cuajo",
    "quajo","sebo","teleco","tripa","tripa de rastro","tripa gorda"
  ].map(norm));
  const REGLAS_PRODUCTO = new Map([
    [norm("Menudo Canadian"),      { origen: "Promerca",  congelado: "S√≠" }],
    [norm("Caja Menudo National"), { origen: "Congelado", congelado: "S√≠" }],
    [norm("Caja Washington"),      { origen: "Daniel",    congelado: "S√≠" }],
    [norm("Lengua"),              { origen: "Anglo",      congelado: "S√≠" }]
  ]);
  const PRODUCTOS_PESO_FIJO_2722 = new Set([ norm("Menudo Canadian"), norm("Caja Menudo National") ]);

  const touched = { origen:false, congelado:false, kilos:false };
  function markTouched(){
    const o = $('#origen'), c = $('#congelado'), k = $('#kilos');
    if(o) o.addEventListener('input', ()=> touched.origen = true);
    if(c) c.addEventListener('change', ()=> touched.congelado = true);
    if(k) k.addEventListener('input', ()=> touched.kilos = true);
  }
  function setIfNotTouched(field, value){
    if(field === 'origen' && !touched.origen) $('#origen').value = value;
    if(field === 'congelado' && !touched.congelado) $('#congelado').value = value;
    if(field === 'kilos' && !touched.kilos) $('#kilos').value = value;
  }
  function aplicarAutofillPorProducto(){
    const p = norm($('#producto')?.value || '');
    touched.origen = touched.congelado = touched.kilos = false;

    if(REGLAS_PRODUCTO.has(p)){
      const r = REGLAS_PRODUCTO.get(p);
      setIfNotTouched('origen', r.origen);
      setIfNotTouched('congelado', r.congelado);
    } else if(PRODUCTOS_VIAJE.has(p)){
      setIfNotTouched('origen', 'Viaje');
      setIfNotTouched('congelado', 'No');
    }
    recalcularKilosSiAplica();
  }
  function recalcularKilosSiAplica(){
    const p = norm($('#producto')?.value || '');
    if(!PRODUCTOS_PESO_FIJO_2722.has(p)) return;
    const piezas = num($('#piezas')?.value);
    if(!piezas) return;
    setIfNotTouched('kilos', (piezas * PESO_CAJA_2722).toFixed(2));
  }

  /* ===========================
     ‚úÖ EDICI√ìN INLINE (igual + ajuste inventario)
  =========================== */
  const editState = {
    envi: new Map(),
    dev:  new Map()
  };

  function startEdit(kind, id){
    const list = (kind === 'envi') ? enviados : devueltos;
    const row = list.find(x=>x.id===id);
    if(!row) return;

    for(const [k,v] of (kind==='envi'?editState.envi:editState.dev).entries()){
      if(v.editing && k !== id) cancelEdit(kind, k);
    }

    const stMap = (kind==='envi') ? editState.envi : editState.dev;
    stMap.set(id, {
      editing:true,
      backup: JSON.parse(JSON.stringify(row)),
      draft:  JSON.parse(JSON.stringify(row))
    });
    renderAll();
  }

  function cancelEdit(kind, id){
    const stMap = (kind==='envi') ? editState.envi : editState.dev;
    const s = stMap.get(id);
    if(!s) return;

    const list = (kind === 'envi') ? enviados : devueltos;
    const idx = list.findIndex(x=>x.id===id);
    if(idx >= 0) list[idx] = s.backup;

    stMap.delete(id);
    renderAll();
  }

  function setDraft(kind, id, field, value){
    const stMap = (kind === 'envi') ? editState.envi : editState.dev;
    const s = stMap.get(id);
    if(!s) return;
    s.draft[field] = value;
  }

  async function saveEdit(kind, id){
    const stMap = (kind==='envi') ? editState.envi : editState.dev;
    const s = stMap.get(id);
    if(!s) return;

    const d = s.draft;

    if(kind === 'envi'){
      const before = s.backup;

      const payload = {
        producto: String(d.producto || '').trim(),
        kilos: Number(parseFloat(d.kilos).toFixed(2)),
        piezas: parseInt(d.piezas || 0, 10) || 0,
        origen: String(d.origen || '').trim(),
        congelado: (d.congelado === 'S√≠' ? 'S√≠' : 'No')
      };

      if(!payload.producto || !Number.isFinite(payload.kilos) || !payload.origen){
        alert("En edici√≥n: producto, kilos y origen son obligatorios.");
        return;
      }

      const { data, error } = await sb
        .from(T_ENVIADOS)
        .update(payload)
        .eq('id', id)
        .select("id, producto, kilos, piezas, origen, congelado, created_at")
        .single();

      if(error){
        console.error(error);
        alert("No se pudo guardar cambios (UPDATE). Revisa RLS / permisos.");
        cancelEdit(kind, id);
        return;
      }

      const idx = enviados.findIndex(x=>x.id===id);
      if(idx>=0){
        enviados[idx] = {
          id:data.id,
          producto:data.producto,
          kilos:+data.kilos,
          piezas:+(data.piezas||0),
          origen:data.origen,
          congelado:data.congelado,
          created_at:data.created_at
        };
      }

      // ‚úÖ AJUSTE inventario: diferencia (nuevo - anterior)
      const deltaKg = Number(payload.kilos||0) - Number(before.kilos||0);
      const deltaPz = Number(payload.piezas||0) - Number(before.piezas||0);

      if(payload.producto !== before.producto){
        await pushMovimiento({
          tipo:"AJUSTE",
          origen: payload.origen || "mostrador",
          ref: `AJU-CHG-${fechaSeleccionada()}-${id}`,
          items: buildItem(before.producto, -Number(before.kilos||0), -Number(before.piezas||0))
        });
        await pushMovimiento({
          tipo:"AJUSTE",
          origen: payload.origen || "mostrador",
          ref: `AJU-CHG-${fechaSeleccionada()}-${id}`,
          items: buildItem(payload.producto, Number(payload.kilos||0), Number(payload.piezas||0))
        });
      } else if(Math.abs(deltaKg) > 0.0001 || Math.abs(deltaPz) > 0.0001){
        await pushMovimiento({
          tipo:"AJUSTE",
          origen: payload.origen || "mostrador",
          ref: `AJU-${fechaSeleccionada()}-${id}`,
          items: buildItem(payload.producto, deltaKg, deltaPz)
        });
      }

    } else {
      const payload = {
        producto: String(d.producto || '').trim(),
        kilos: Number(parseFloat(d.kilos).toFixed(2))
      };
      if(!payload.producto || !Number.isFinite(payload.kilos)){
        alert("En devueltos: producto y kilos son obligatorios.");
        return;
      }

      const before = s.backup;

      const { data, error } = await sb
        .from(T_DEVUELTOS)
        .update(payload)
        .eq('id', id)
        .select("id, producto, kilos, created_at")
        .single();

      if(error){
        console.error(error);
        alert("No se pudo guardar cambios (UPDATE) en devueltos. Revisa RLS.");
        cancelEdit(kind, id);
        return;
      }

      const idx = devueltos.findIndex(x=>x.id===id);
      if(idx>=0){
        devueltos[idx] = { id:data.id, producto:data.producto, kilos:+data.kilos, created_at:data.created_at };
      }

      // ‚úÖ Ajuste inventario (DEVOLUCION editada): delta nuevo-anterior
      const deltaKg = Number(payload.kilos||0) - Number(before.kilos||0);
      if(Math.abs(deltaKg) > 0.0001 || payload.producto !== before.producto){
        if(payload.producto !== before.producto){
          await pushMovimiento({
            tipo:"AJUSTE",
            origen:"mostrador",
            ref:`AJU-DEV-CHG-${fechaSeleccionada()}-${id}`,
            items: buildItem(before.producto, -Number(before.kilos||0), 0)
          });
          await pushMovimiento({
            tipo:"AJUSTE",
            origen:"mostrador",
            ref:`AJU-DEV-CHG-${fechaSeleccionada()}-${id}`,
            items: buildItem(payload.producto, Number(payload.kilos||0), 0)
          });
        } else {
          await pushMovimiento({
            tipo:"AJUSTE",
            origen:"mostrador",
            ref:`AJU-DEV-${fechaSeleccionada()}-${id}`,
            items: buildItem(payload.producto, deltaKg, 0)
          });
        }
      }
    }

    stMap.delete(id);
    renderAll();
  }

  /* ===== Render tablas ===== */
  function renderTablaEnviados() {
    const tbody = document.querySelector("#tablaEnviados tbody");
    tbody.innerHTML = enviados.map((item) => {
      const st = editState.envi.get(item.id);
      const editing = !!st?.editing;
      const d = editing ? st.draft : item;

      return `
      <tr>
        <td>${
          editing
            ? `<input class="cellInput" value="${escapeHtml(d.producto)}"
                 oninput="setDraft('envi','${item.id}','producto', this.value)">`
            : `${escapeHtml(item.producto)}`
        }</td>

        <td>${
          editing
            ? `<input class="cellInput" type="number" step="0.01" value="${Number(d.kilos||0).toFixed(2)}"
                 oninput="setDraft('envi','${item.id}','kilos', this.value)">`
            : `${(+item.kilos).toFixed(2)}`
        }</td>

        <td>${
          editing
            ? `<input class="cellInput" type="number" value="${parseInt(d.piezas||0,10)}"
                 oninput="setDraft('envi','${item.id}','piezas', this.value)">`
            : `${item.piezas || 0}`
        }</td>

        <td>${
          editing
            ? `<input class="cellInput" value="${escapeHtml(d.origen||'')}"
                 oninput="setDraft('envi','${item.id}','origen', this.value)">`
            : `${escapeHtml(item.origen || '')}`
        }</td>

        <td>${
          editing
            ? `<select class="cellSelect"
                 onchange="setDraft('envi','${item.id}','congelado', this.value)">
                 <option value="No" ${d.congelado==='No'?'selected':''}>No</option>
                 <option value="S√≠" ${d.congelado==='S√≠'?'selected':''}>S√≠</option>
               </select>`
            : `${escapeHtml(item.congelado || 'No')}`
        }</td>

        <td>
          <div class="miniBtnRow">
            ${
              editing
                ? `
                  <button class="miniBtn" onclick="saveEdit('envi','${item.id}')">Guardar</button>
                  <button class="miniBtn gray" onclick="cancelEdit('envi','${item.id}')">Cancelar</button>
                `
                : `
                  <button class="miniBtn" onclick="startEdit('envi','${item.id}')">Editar</button>
                  <button class="miniBtn red" onclick="eliminarProducto('${item.id}')">Eliminar</button>
                `
            }
          </div>
        </td>
      </tr>`;
    }).join('');
  }

  function renderTablaDevueltos() {
    const tbody = document.querySelector("#tablaDevueltos tbody");
    tbody.innerHTML = devueltos.map((item) => {
      const st = editState.dev.get(item.id);
      const editing = !!st?.editing;
      const d = editing ? st.draft : item;

      return `
      <tr>
        <td>${
          editing
            ? `<input class="cellInput" value="${escapeHtml(d.producto)}"
                 oninput="setDraft('dev','${item.id}','producto', this.value)">`
            : `${escapeHtml(item.producto)}`
        }</td>

        <td>${
          editing
            ? `<input class="cellInput" type="number" step="0.01" value="${Number(d.kilos||0).toFixed(2)}"
                 oninput="setDraft('dev','${item.id}','kilos', this.value)">`
            : `${(+item.kilos).toFixed(2)}`
        }</td>

        <td>
          <div class="miniBtnRow">
            ${
              editing
                ? `
                  <button class="miniBtn" onclick="saveEdit('dev','${item.id}')">Guardar</button>
                  <button class="miniBtn gray" onclick="cancelEdit('dev','${item.id}')">Cancelar</button>
                `
                : `
                  <button class="miniBtn" onclick="startEdit('dev','${item.id}')">Editar</button>
                  <button class="miniBtn red" onclick="eliminarDevuelto('${item.id}')">Eliminar</button>
                `
            }
          </div>
        </td>
      </tr>`;
    }).join('');
  }

  /* ===== Resumen + chart ===== */
  function buildResumen(){
    const map = new Map();
    for(const r of enviados){
      const k = r.producto;
      if(!map.has(k)) map.set(k, { producto:k, kilos:0, piezas:0 });
      const o = map.get(k);
      o.kilos += num(r.kilos);
      o.piezas += parseInt(r.piezas||0,10);
    }
    return Array.from(map.values()).sort((a,b)=>b.kilos-a.kilos);
  }
  function renderResumen(){
    const rows = buildResumen();
    const tbody = document.querySelector("#tablaResumen tbody");
    tbody.innerHTML = rows.map(r=>`
      <tr>
        <td>${escapeHtml(r.producto)}</td>
        <td>${r.kilos.toFixed(2)}</td>
        <td>${r.piezas}</td>
      </tr>
    `).join('');
  }

  let chartResumen = null;
  function renderChart(){
    const rows = buildResumen();
    const labels = rows.map(r=>r.producto);
    const kilos = rows.map(r=>Number(r.kilos.toFixed(2)));
    const piezas = rows.map(r=>r.piezas);
    const canvas = document.getElementById('chartResumen');
    if(!canvas) return;

    if(chartResumen){
      chartResumen.data.labels = labels;
      chartResumen.data.datasets[0].data = kilos;
      chartResumen.data.datasets[1].data = piezas;
      chartResumen.update();
      return;
    }

    chartResumen = new Chart(canvas, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Kilos', data: kilos },
          { label: 'Piezas', data: piezas }
        ]
      },
      options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
    });
  }

  function renderAll(){
    renderTablaEnviados();
    renderTablaDevueltos();
    renderResumen();
    renderChart();
  }

  /* ===== Cargar d√≠a ===== */
  async function cargarDia(fecha){
    if(!sb){ alert("No carg√≥ Supabase. Revisa el CDN o internet."); return; }

    const { data: env, error: e1 } = await sb
      .from(T_ENVIADOS)
      .select("id, producto, kilos, piezas, origen, congelado, created_at")
      .eq("fecha", fecha)
      .order("created_at", { ascending: false });

    if(e1) console.error(e1);

    const { data: dev, error: e2 } = await sb
      .from(T_DEVUELTOS)
      .select("id, producto, kilos, created_at")
      .eq("fecha", fecha)
      .order("created_at", { ascending: false });

    if(e2) console.error(e2);

    enviados = (env || []).map(x=>({
      id:x.id,
      producto:x.producto,
      kilos:+x.kilos,
      piezas:+(x.piezas||0),
      origen:x.origen,
      congelado:x.congelado,
      created_at:x.created_at
    }));
    devueltos = (dev || []).map(x=>({
      id:x.id,
      producto:x.producto,
      kilos:+x.kilos,
      created_at:x.created_at
    }));

    editState.envi.clear();
    editState.dev.clear();

    renderAll();
  }

  /* ===== Realtime ===== */
  async function conectarRealtime(fecha){
    if(!sb) return;

    if(rtChannel){
      try { await sb.removeChannel(rtChannel); } catch(e){}
      rtChannel = null;
    }

    rtChannel = sb.channel(`mostrador-rt-${fecha}`);

    rtChannel
      .on('postgres_changes',
        { event:'INSERT', schema:'public', table:T_ENVIADOS, filter:`fecha=eq.${fecha}` },
        (payload)=>{
          const r = payload.new;
          if(enviados.some(x=>x.id===r.id)) return;
          enviados.unshift({
            id:r.id, producto:r.producto, kilos:+r.kilos, piezas:+(r.piezas||0),
            origen:r.origen, congelado:r.congelado, created_at:r.created_at
          });
          renderAll();
        }
      )
      .on('postgres_changes',
        { event:'DELETE', schema:'public', table:T_ENVIADOS, filter:`fecha=eq.${fecha}` },
        (payload)=>{
          const id = payload.old?.id;
          if(!id) return;
          enviados = enviados.filter(x=>x.id!==id);
          editState.envi.delete(id);
          renderAll();
        }
      )
      .on('postgres_changes',
        { event:'UPDATE', schema:'public', table:T_ENVIADOS, filter:`fecha=eq.${fecha}` },
        (payload)=>{
          const r = payload.new;
          const idx = enviados.findIndex(x=>x.id===r.id);
          if(idx>=0 && !editState.envi.get(r.id)?.editing){
            enviados[idx] = {
              id:r.id, producto:r.producto, kilos:+r.kilos, piezas:+(r.piezas||0),
              origen:r.origen, congelado:r.congelado, created_at:r.created_at
            };
            renderAll();
          }
        }
      )
      .on('postgres_changes',
        { event:'INSERT', schema:'public', table:T_DEVUELTOS, filter:`fecha=eq.${fecha}` },
        (payload)=>{
          const r = payload.new;
          if(devueltos.some(x=>x.id===r.id)) return;
          devueltos.unshift({ id:r.id, producto:r.producto, kilos:+r.kilos, created_at:r.created_at });
          renderAll();
        }
      )
      .on('postgres_changes',
        { event:'DELETE', schema:'public', table:T_DEVUELTOS, filter:`fecha=eq.${fecha}` },
        (payload)=>{
          const id = payload.old?.id;
          if(!id) return;
          devueltos = devueltos.filter(x=>x.id!==id);
          editState.dev.delete(id);
          renderAll();
        }
      )
      .on('postgres_changes',
        { event:'UPDATE', schema:'public', table:T_DEVUELTOS, filter:`fecha=eq.${fecha}` },
        (payload)=>{
          const r = payload.new;
          const idx = devueltos.findIndex(x=>x.id===r.id);
          if(idx>=0 && !editState.dev.get(r.id)?.editing){
            devueltos[idx] = { id:r.id, producto:r.producto, kilos:+r.kilos, created_at:r.created_at };
            renderAll();
          }
        }
      );

    await rtChannel.subscribe((s)=>{
      const pill = $('#rt');
      if(!pill) return;
      if(s === 'SUBSCRIBED'){ pill.textContent = 'REAL TIME'; pill.classList.remove('bad'); pill.classList.add('ok'); }
      else if(s === 'CHANNEL_ERROR' || s === 'TIMED_OUT'){ pill.textContent = 'RT: ' + s; pill.classList.remove('ok'); pill.classList.add('bad'); }
      else { pill.textContent = 'RT: ' + s; }
    });
  }

  /* ===== Inserts (con ledger) ===== */
  async function agregarProducto(){
    const fecha = fechaSeleccionada();
    const producto = $('#producto').value;
    const kilos = $('#kilos').value;
    const piezas = $('#piezas').value || 0;
    const origen = $('#origen').value;
    const congelado = $('#congelado').value;

    if(!producto || !kilos || !origen){
      alert("Por favor completa los campos obligatorios.");
      return;
    }

    const row = {
      fecha,
      producto,
      kilos: Number(parseFloat(kilos).toFixed(2)),
      piezas: parseInt(piezas || 0, 10) || 0,
      origen,
      congelado
    };

    const { data, error } = await sb
      .from(T_ENVIADOS)
      .insert(row)
      .select("id, producto, kilos, piezas, origen, congelado, created_at")
      .single();

    if(error){
      console.error(error);
      alert("No se pudo guardar. Revisa internet o pol√≠ticas RLS / Realtime.");
      return;
    }

    // ‚úÖ Movimiento inventario (ENVIO)
    await pushMovimiento({
      tipo: "ENVIO",
      origen: origen || "mostrador",
      ref: `ENV-${fecha}-${data.id}`,
      items: buildItem(producto, row.kilos, row.piezas)
    });

    if(!enviados.some(x=>x.id===data.id)){
      enviados.unshift({
        id:data.id, producto:data.producto, kilos:+data.kilos, piezas:+(data.piezas||0),
        origen:data.origen, congelado:data.congelado, created_at:data.created_at
      });
      renderAll();
    }

    $('#kilos').value = '';
    $('#piezas').value = '';
  }

  async function agregarDevuelto(){
    const fecha = fechaSeleccionada();
    const producto = $('#productoDevuelto').value;
    const kilos = $('#kilosDevuelto').value;

    if(!producto || !kilos){
      alert("Completa ambos campos del producto devuelto.");
      return;
    }

    const row = { fecha, producto, kilos: Number(parseFloat(kilos).toFixed(2)) };

    const { data, error } = await sb
      .from(T_DEVUELTOS)
      .insert(row)
      .select("id, producto, kilos, created_at")
      .single();

    if(error){
      console.error(error);
      alert("No se pudo guardar devuelto. Revisa internet o RLS / Realtime.");
      return;
    }

    // ‚úÖ Movimiento inventario (DEVOLUCION)
    await pushMovimiento({
      tipo: "DEVOLUCION",
      origen: "mostrador",
      ref: `DEV-${fecha}-${data.id}`,
      items: buildItem(producto, row.kilos, 0)
    });

    if(!devueltos.some(x=>x.id===data.id)){
      devueltos.unshift({ id:data.id, producto:data.producto, kilos:+data.kilos, created_at:data.created_at });
      renderAll();
    }

    $('#productoDevuelto').value = '';
    $('#kilosDevuelto').value = '';
  }

  async function eliminarProducto(id){
    if(!id) return;

    const row = enviados.find(x=>x.id===id);
    if(!row){
      alert("No encontr√© el registro para revertir inventario.");
      return;
    }

    // ‚úÖ Revertir inventario (AJUSTE negativo)
    await pushMovimiento({
      tipo: "AJUSTE",
      origen: row.origen || "mostrador",
      ref: `DEL-${fechaSeleccionada()}-${id}`,
      items: buildItem(row.producto, -Number(row.kilos||0), -Number(row.piezas||0))
    });

    const { error } = await sb.from(T_ENVIADOS).delete().eq('id', id);
    if(error){ console.error(error); alert("No se pudo eliminar. Revisa internet o RLS."); }
  }

  async function eliminarDevuelto(id){
    if(!id) return;

    const row = devueltos.find(x=>x.id===id);
    if(!row){
      alert("No encontr√© el devuelto para revertir inventario.");
      return;
    }

    // ‚úÖ Revertir el efecto de la devoluci√≥n (AJUSTE negativo)
    await pushMovimiento({
      tipo: "AJUSTE",
      origen: "mostrador",
      ref: `DELDEV-${fechaSeleccionada()}-${id}`,
      items: buildItem(row.producto, -Number(row.kilos||0), 0)
    });

    const { error } = await sb.from(T_DEVUELTOS).delete().eq('id', id);
    if(error){ console.error(error); alert("No se pudo eliminar devuelto. Revisa internet o RLS."); }
  }

  /* ===== WhatsApp ===== */
  function enviarWhatsApp(){
    const fecha = fechaSeleccionada();
    const agrupadoEnviados = {};
    const agrupadoDevueltos = {};
    let totalKilosEnviados = 0;
    let totalKilosDevueltos = 0;

    enviados.forEach(p => {
      if(!agrupadoEnviados[p.producto]) agrupadoEnviados[p.producto] = { kilos:0, piezas:0 };
      agrupadoEnviados[p.producto].kilos += num(p.kilos);
      agrupadoEnviados[p.producto].piezas += parseInt(p.piezas||0,10);
      totalKilosEnviados += num(p.kilos);
    });

    devueltos.forEach(p => {
      if(!agrupadoDevueltos[p.producto]) agrupadoDevueltos[p.producto] = 0;
      agrupadoDevueltos[p.producto] += num(p.kilos);
      totalKilosDevueltos += num(p.kilos);
    });

    let mensaje = `*Resumen VDC 360¬∞ - ${fecha}*\n\n`;
    mensaje += `üü¢ *Productos enviados:*\n`;
    for(const [producto, datos] of Object.entries(agrupadoEnviados)){
      mensaje += `‚Ä¢ ${producto}: ${datos.kilos.toFixed(2)} kg / ${datos.piezas} pzas\n`;
    }
    mensaje += `\nüì¶ *Total kilos enviados:* ${totalKilosEnviados.toFixed(2)} kg\n`;

    if(devueltos.length > 0){
      mensaje += `\nüî¥ *Productos devueltos:*\n`;
      for(const [producto, kilos] of Object.entries(agrupadoDevueltos)){
        mensaje += `‚Ä¢ ${producto}: ${kilos.toFixed(2)} kg\n`;
      }
      mensaje += `\nüì¶ *Total kilos devueltos:* ${totalKilosDevueltos.toFixed(2)} kg\n`;
    }

    const url = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
    window.open(url, "_blank");
  }

  /* ===== Arranque ===== */
  document.getElementById("fecha").value = todayISODate();
  ordenarSelectAlfabeticamente('producto');
  markTouched();

  $('#producto').addEventListener('change', aplicarAutofillPorProducto);
  $('#piezas').addEventListener('input', ()=>{ touched.kilos = false; recalcularKilosSiAplica(); });

  $('#btnAgregar').addEventListener('click', agregarProducto);
  $('#btnAgregarDev').addEventListener('click', agregarDevuelto);

  $('#btnPeso').addEventListener('click', leerBasculaOnce);
  $('#rtPesoToggle').addEventListener('change', async (e)=>{
    if(e.target.checked){
      await conectarBasculaRealtime();
      await leerBasculaOnce();
    }else{
      await apagarBasculaRealtime();
    }
  });

  async function iniciar(){
    const f = fechaSeleccionada();
    await cargarDia(f);
    await conectarRealtime(f);
    aplicarAutofillPorProducto();
    setPesoStatus("B√°scula: esperando‚Ä¶", true);
  }

  $('#fecha').addEventListener('change', async ()=>{
    const f = fechaSeleccionada();
    await cargarDia(f);
    await conectarRealtime(f);
  });

  iniciar();

  /* ‚úÖ Exponer funciones para onclick inline */
  window.startEdit = startEdit;
  window.cancelEdit = cancelEdit;
  window.saveEdit = saveEdit;
  window.setDraft = setDraft;
  window.eliminarProducto = eliminarProducto;
  window.eliminarDevuelto = eliminarDevuelto;
  window.enviarWhatsApp = enviarWhatsApp;
</script>

</body>
</html>
