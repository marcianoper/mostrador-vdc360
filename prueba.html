<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro Mostrador VDC 360°</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
    h1 { color: #2e7d32; }
    .container { background: white; border-radius: 10px; padding: 20px; max-width: 1000px; margin: auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    input, select, button { padding: 8px; margin: 5px 0; width: 100%; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #2e7d32; color: white; }
    .btn { background: #2e7d32; color: white; border: none; cursor: pointer; }
    .btn:hover { background: #1b5e20; }
    .btn-danger { background: #c62828; }
    .btn-danger:hover { background: #b71c1c; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <div class="container">
    <h1>Registro Mostrador VDC 360°</h1>
    <label>Fecha:</label>
    <input type="date" id="fecha">
    <label>Producto:</label>
    <select id="producto"></select>
    <label>Kilos:</label>
    <input type="number" id="kilos">
    <label>Piezas (opcional):</label>
    <input type="number" id="piezas">
    <label>Origen:</label>
    <input type="text" id="origen">
    <label>¿Es congelado?</label>
    <select id="congelado">
      <option value="No">No</option>
      <option value="Sí">Sí</option>
    </select>
    <button class="btn" onclick="agregarProducto()">Agregar producto</button>

    <h3>Productos enviados</h3>
    <table id="tabla">
      <thead>
        <tr><th>Producto</th><th>Kilos</th><th>Piezas</th><th>Origen</th><th>Congelado</th><th>Acción</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>Productos devueltos</h3>
    <label>Producto devuelto:</label>
    <select id="productoDevuelto"></select>
    <label>Kilos devueltos:</label>
    <input type="number" id="kilosDevueltos">
    <label>Piezas devueltas:</label>
    <input type="number" id="piezasDevueltas">
    <button class="btn" onclick="agregarDevolucion()">Agregar devolución</button>

    <table id="tablaDevueltos">
      <thead>
        <tr><th>Producto</th><th>Kilos</th><th>Piezas</th><th>Acción</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <button class="btn" onclick="generarDocumento()">Generar documento final</button>
  </div>

<script>
  const supabase = supabase.createClient(
    "https://eqynjddcosvdqjzztznn.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxeW5qZGRjb3N2ZHFqenp0em5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMzYwMzIsImV4cCI6MjA3MTcxMjAzMn0.Q51wsGelUvxRfqsMYRY5JduCGyZ7s6AzOhqsRf3kOhk"
  );

  const productos = [];
  const devoluciones = [];

  window.onload = () => {
    const listaProductos = [
      "Bofe","Corazón","Hígado","Lengua de res","Tripa","Cuajo","Panza fresca o menudo fresco",
      "Libro","Pata blanca","Pata morena","Tripa de rastro","Cabeza de res con lengua","Cabeza sin lengua",
      "Teleco","Caja menudo vísceras","Menudo National","Caja de Menudo National","Caja Excel",
      "Menudo Canadian","Cabeza de Rastro","Sebo","Tripa Gorda","Nana","Washington","Otro"
    ];
    listaProductos.forEach(p => {
      const option = `<option>${p}</option>`;
      document.getElementById('producto').innerHTML += option;
      document.getElementById('productoDevuelto').innerHTML += option;
    });
  };

  function agregarProducto() {
    const prod = document.getElementById('producto').value;
    const kg = parseFloat(document.getElementById('kilos').value) || 0;
    const piezas = parseInt(document.getElementById('piezas').value) || 0;
    const origen = document.getElementById('origen').value;
    const congelado = document.getElementById('congelado').value;

    if (!prod || kg === 0) return;

    const existente = productos.find(p => p.producto === prod);
    if (existente) {
      existente.kilos += kg;
      existente.piezas += piezas;
    } else {
      productos.push({ producto: prod, kilos: kg, piezas, origen, congelado });
    }
    actualizarTabla();
    document.getElementById('producto').value = "";
    document.getElementById('kilos').value = "";
    document.getElementById('piezas').value = "";
    document.getElementById('origen').value = "";
    document.getElementById('congelado').value = "No";
  }

  function eliminarProducto(index) {
    productos.splice(index, 1);
    actualizarTabla();
  }

  function actualizarTabla() {
    const cuerpo = document.querySelector('#tabla tbody');
    cuerpo.innerHTML = "";
    productos.forEach((p, i) => {
      cuerpo.innerHTML += `<tr><td>${p.producto}</td><td>${p.kilos}</td><td>${p.piezas}</td><td>${p.origen}</td><td>${p.congelado}</td><td><button class='btn btn-danger' onclick='eliminarProducto(${i})'>Eliminar</button></td></tr>`;
    });
  }

  function agregarDevolucion() {
    const prod = document.getElementById('productoDevuelto').value;
    const kg = parseFloat(document.getElementById('kilosDevueltos').value) || 0;
    const piezas = parseInt(document.getElementById('piezasDevueltas').value) || 0;

    if (!prod || kg === 0) return;

    const existente = devoluciones.find(p => p.producto === prod);
    if (existente) {
      existente.kilos += kg;
      existente.piezas += piezas;
    } else {
      devoluciones.push({ producto: prod, kilos: kg, piezas });
    }
    actualizarDevueltos();
    document.getElementById('productoDevuelto').value = "";
    document.getElementById('kilosDevueltos').value = "";
    document.getElementById('piezasDevueltas').value = "";
  }

  function eliminarDevolucion(index) {
    devoluciones.splice(index, 1);
    actualizarDevueltos();
  }

  function actualizarDevueltos() {
    const cuerpo = document.querySelector('#tablaDevueltos tbody');
    cuerpo.innerHTML = "";
    devoluciones.forEach((p, i) => {
      cuerpo.innerHTML += `<tr><td>${p.producto}</td><td>${p.kilos}</td><td>${p.piezas}</td><td><button class='btn btn-danger' onclick='eliminarDevolucion(${i})'>Eliminar</button></td></tr>`;
    });
  }

  async function generarDocumento() {
    const fecha = document.getElementById('fecha').value;
    if (!fecha || productos.length === 0) return alert("Faltan datos");

    const resumen = {};
    productos.forEach(p => {
      if (!resumen[p.producto]) resumen[p.producto] = 0;
      resumen[p.producto] += p.kilos;
    });
    devoluciones.forEach(d => {
      if (!resumen[d.producto]) resumen[d.producto] = 0;
      resumen[d.producto] -= d.kilos;
    });

    let mensaje = `Resumen VDC 360° - ${fecha}\n`;
    for (const prod in resumen) {
      mensaje += `\n${prod}: ${resumen[prod]} kg`;
    }

    const { error } = await supabase.from('envios_mostrador').insert({
      fecha,
      productos: JSON.stringify(productos),
      devoluciones: JSON.stringify(devoluciones),
      resumen: mensaje
    });

    if (error) return alert("Error al guardar en Supabase: " + error.message);

    const link = `https://api.whatsapp.com/send?text=${encodeURIComponent(mensaje)}`;
    window.open(link, '_blank');
  }
</script>
</body>
</html>


